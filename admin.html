<!doctype html>
<html lang="en" data-theme="pastel">
  <head>
    <base target="_top" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin Panel - Placement Portal</title>
    <link
      href="https://cdn.jsdelivr.net/npm/daisyui@5"
      rel="stylesheet"
      type="text/css"
    />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/daisyui@5/themes.css"
      rel="stylesheet"
      type="text/css"
    />

    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
      lucide.createIcons();
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
  </head>
  <body
    class="h-screen grow-0 flex bg-base-200 font-['Inter',sans-serif] p-4 gap-4 overflow-hidden"
  >
    <!-- Enhanced Floating Sidebar Navigation -->
    <div class="h-full w-72 bg-base-100 shadow-2xl rounded-2xl flex flex-col">
      <!-- Sidebar Header -->
      <div class="p-6 border-b border-base-300 rounded-t-2xl">
        <div class="flex items-center gap-4">
          <div
            class="w-12 h-12 bg-neutral rounded-xl flex items-center justify-center"
          >
            <i
              data-lucide="graduation-cap"
              class="w-7 h-7 text-neutral-content"
            ></i>
          </div>
          <div>
            <h1 class="text-lg font-semibold text-base-content">
              Placement Portal
            </h1>
            <div class="flex items-center gap-2 mt-1">
              <div class="badge badge-neutral badge-sm">Admin</div>
              <span class="text-xs text-base-content/60">•</span>
              <div
                id="user-info"
                class="text-xs text-base-content/80 font-medium"
              >
                Authenticating...
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Navigation Menu -->
      <nav class="p-4 flex-1 flex flex-col gap-4" id="adminTabs">
        <a
          role="tab"
          class="nav-item btn btn-ghost w-full justify-start gap-3 px-4 py-3 h-auto font-normal normal-case"
          data-section="manage"
        >
          <div
            class="w-8 h-8 rounded-lg bg-base-200 flex items-center justify-center"
          >
            <i data-lucide="folder-open" class="w-5 h-5 text-black"></i>
          </div>
          <span>Manage Forms</span>
        </a>

        <a
          role="tab"
          class="nav-item btn btn-ghost w-full justify-start gap-3 px-4 py-3 h-auto font-normal normal-case"
          data-section="create"
        >
          <div
            class="w-8 h-8 rounded-lg bg-base-200 flex items-center justify-center"
          >
            <i data-lucide="plus-circle" class="w-5 h-5 text-black"></i>
          </div>
          <span>Create Form</span>
        </a>

        <a
          role="tab"
          class="nav-item btn btn-ghost w-full justify-start gap-3 px-4 py-3 h-auto font-normal normal-case"
          data-section="email"
        >
          <div
            class="w-8 h-8 rounded-lg bg-base-200 flex items-center justify-center"
          >
            <i data-lucide="mail" class="w-5 h-5 text-black"></i>
          </div>
          <span>Email Students</span>
        </a>

        <a
          role="tab"
          class="nav-item btn btn-ghost w-full justify-start gap-3 px-4 py-3 h-auto font-normal normal-case"
          data-section="students"
        >
          <div
            class="w-8 h-8 rounded-lg bg-base-200 flex items-center justify-center"
          >
            <i data-lucide="users" class="w-5 h-5 text-black"></i>
          </div>
          <span>Student Data</span>
        </a>

        <a
          role="tab"
          class="nav-item btn btn-ghost w-full justify-start gap-3 px-4 py-3 h-auto font-normal normal-case"
          data-section="rbac"
        >
          <div
            class="w-8 h-8 rounded-lg bg-base-200 flex items-center justify-center"
          >
            <i data-lucide="shield-check" class="w-5 h-5 text-black"></i>
          </div>
          <span>Access Control</span>
        </a>
      </nav>

      <!-- Sidebar Footer -->
      <div class="p-4 border-t border-base-300 rounded-b-2xl">
        <div class="text-center">
          <div class="text-xs text-base-content font-medium">
            Admin Panel v2.0
          </div>
          <div class="text-xs text-neutral mt-1">© 2025 CSE Placement Portal</div>
        </div>
      </div>
    </div>

    <!-- Main Content Area -->
    <div
      class="h-full flex-1 flex flex-col bg-base-100 rounded-2xl shadow-lg p-6"
    >
      <!-- Login Alert -->
      <div id="loginSection" class="hidden mb-4">
        <div class="alert alert-error">
          <i data-lucide="alert-circle" class="w-5 h-5"></i>
          <span id="loginMessage"></span>
        </div>
      </div>

      <!-- Page Content -->
      <div class="flex-1 p-6 bg-base-200 overflow-auto">
        <div class="max-w-7xl mx-auto space-y-6">
          <div id="managePage" class="space-y-6">
            <!-- Simple Page Header -->
            <div class="flex items-center justify-between">
              <div>
                <h2 class="text-3xl font-bold">Manage Forms</h2>
                <p class="text-neutral">View and manage placement forms</p>
              </div>
              <div class="flex items-center gap-4">
                <div id="formsStatsDisplay" class="text-sm">Loading...</div>
                <div class="flex gap-2">
                  <button onclick="refreshForms()" class="btn btn-ghost btn-sm">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                  </button>
                  <button
                    onclick="navigateToSection('create')"
                    class="btn btn-primary"
                  >
                    <i data-lucide="plus" class="w-4 h-4"></i>
                    Create Form
                  </button>
                </div>
              </div>
            </div>

            <div id="manageMessage" class="status-message"></div>

            <!-- Forms Table -->
            <div id="formsTableContainer" class="card bg-base-100 shadow-lg">
              <div class="card-body p-0">
                <div class="overflow-x-auto">
                  <table class="table table-zebra">
                    <thead class="bg-base-200">
                      <tr>
                        <th class="font-semibold text-base-content">
                          Form Name
                        </th>
                        <th class="font-semibold text-base-content text-center">
                          Status
                        </th>
                        <th
                          class="font-semibold text-base-content hidden sm:table-cell"
                        >
                          Deadline
                        </th>
                        <th class="font-semibold text-base-content text-center">
                          Responses
                        </th>
                        <th class="font-semibold text-base-content text-right">
                          Actions
                        </th>
                      </tr>
                    </thead>
                    <tbody id="formsTbody">
                      <!-- Forms will be rendered here -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- Simplified Edit Properties Modal -->
            <dialog id="editPropertiesModal" class="modal">
              <div class="modal-box w-11/12 max-w-6xl">
                <form method="dialog">
                  <button
                    class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2"
                  >
                    <i data-lucide="x" class="w-4 h-4"></i>
                  </button>
                </form>

                <h3 class="font-bold text-lg">Form Settings</h3>
                <p class="text-sm text-neutral mb-4">
                  Configure
                  <span
                    id="propsFormName"
                    class="font-medium text-primary"
                  ></span>
                </p>

                <div class="space-y-6">
                  <input type="hidden" id="propsFormNameHidden" />

                  <!-- Deadline -->
                  <div class="form-control">
                    <div class="flex items-center justify-between mb-2">
                      <label class="label-text font-medium"
                        >Application Deadline</label
                      >
                      <span class="text-xs text-neutral">Optional</span>
                    </div>
                    <input
                      type="datetime-local"
                      id="propsDeadlineInput"
                      class="input input-bordered w-full"
                    />
                  </div>

                  <!-- Description -->
                  <div class="form-control">
                    <label class="label-text font-medium mb-2 block"
                      >Description</label
                    >
                    <textarea
                      id="propsDescription"
                      class="textarea textarea-bordered h-24 w-full"
                      placeholder="Job description and instructions..."
                    ></textarea>
                  </div>

                  <!-- File Link -->
                  <div class="form-control">
                    <div class="flex items-center justify-between mb-2">
                      <label class="label-text font-medium"
                        >Resources Link</label
                      >
                      <span class="text-xs text-neutral"
                        >Google Drive link</span
                      >
                    </div>
                    <input
                      type="url"
                      id="propsFileLink"
                      class="input input-bordered w-full"
                      placeholder="https://drive.google.com/..."
                    />
                  </div>

                  <!-- Student Access -->
                  <div class="form-control">
                    <div class="flex items-center justify-between mb-2">
                      <label class="label-text font-medium"
                        >Allowed Students</label
                      >
                      <span class="text-xs text-neutral"
                        >Empty = all students</span
                      >
                    </div>
                    <div
                      id="propsStudentSelector"
                      class="border border-base-300 rounded-lg min-h-[80px] p-3 bg-base-50"
                    ></div>
                  </div>

                  <div id="propsSaveMessage" class="status-message"></div>
                </div>

                <div class="modal-action pt-6 border-t border-base-200">
                  <button
                    id="savePropsBtn"
                    onclick="saveProperties()"
                    class="btn btn-primary"
                  >
                    <i data-lucide="save" class="w-4 h-4"></i>
                    Save Changes
                  </button>
                </div>
              </div>
            </dialog>

            <!-- Simplified Edit Panel -->
            <dialog id="editFieldsModal" class="modal">
              <div class="modal-box w-11/12 max-w-6xl">
                <form method="dialog">
                  <button
                    class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2"
                  >
                    <i data-lucide="x" class="w-4 h-4"></i>
                  </button>
                </form>

                <div class="space-y-6">
                  <div class="pb-4 border-b border-base-200">
                    <h3 class="text-xl font-bold">Edit Form Fields</h3>
                    <p class="text-sm text-neutral mt-1">
                      Configuring
                      <span
                        id="editFormNameLabel"
                        class="font-medium text-primary"
                      ></span>
                    </p>
                  </div>

                  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Available Fields -->
                    <div
                      class="card bg-base-100 shadow-sm border border-base-200"
                    >
                      <div class="card-body p-5">
                        <h4 class="card-title text-base mb-2">
                          <i data-lucide="database" class="w-4 h-4"></i>
                          Available Fields
                        </h4>
                        <p class="text-sm text-neutral mb-3">
                          Student profile fields
                        </p>
                        <div
                          id="editAvailableList"
                          class="h-48 overflow-y-auto space-y-2 bg-base-50 p-3 rounded-lg border border-base-200"
                        ></div>
                      </div>
                    </div>

                    <!-- Selected Fields -->
                    <div
                      class="card bg-base-100 shadow-sm border border-base-200"
                    >
                      <div class="card-body p-5">
                        <h4 class="card-title text-base mb-2">
                          <i data-lucide="check-square" class="w-4 h-4"></i>
                          Selected Fields
                        </h4>
                        <p class="text-sm text-neutral mb-3">Drag to reorder</p>
                        <div
                          id="editSelectedList"
                          class="h-48 overflow-y-auto space-y-2 bg-base-50 p-3 rounded-lg border border-base-200 min-h-[100px]"
                        ></div>
                      </div>
                    </div>

                    <!-- Add Custom Field -->
                    <div
                      class="card bg-base-100 shadow-sm border border-base-200"
                    >
                      <div class="card-body p-5">
                        <h4 class="card-title text-base mb-3">
                          <i data-lucide="plus-square" class="w-4 h-4"></i>
                          Add Custom Field
                        </h4>
                        <div class="space-y-4">
                          <div class="form-control">
                            <label class="label-text font-medium mb-1 block"
                              >Field Name</label
                            >
                            <input
                              type="text"
                              id="editCustomFieldName"
                              class="input input-bordered input-sm w-full"
                              placeholder="Field Name"
                            />
                          </div>

                          <div class="form-control">
                            <label class="label-text font-medium mb-1 block"
                              >Field Type</label
                            >
                            <select
                              id="editCustomFieldType"
                              class="select select-bordered select-sm w-full"
                            >
                              <option value="text">Text Input</option>
                              <option value="textarea">Long Text</option>
                              <option value="file">File Upload</option>
                              <option value="dropdown">Dropdown</option>
                              <option value="radio">Radio Buttons</option>
                            </select>
                          </div>

                          <div class="form-control">
                            <label class="label-text font-medium mb-1 block"
                              >Options</label
                            >
                            <input
                              type="text"
                              id="editCustomFieldOptions"
                              class="input input-bordered input-sm w-full"
                              placeholder="Comma-separated options"
                            />
                          </div>

                          <button
                            onclick="editAddCustomField()"
                            class="btn btn-primary btn-sm w-full"
                          >
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            Add Field
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Save Actions -->
                  <div
                    class="flex justify-between items-center pt-4 border-t border-base-200"
                  >
                    <div id="editSaveMessage" class="status-message"></div>
                    <div class="flex gap-3">
                      <button class="btn btn-ghost" onclick="closeEditPanel()">
                        Cancel
                      </button>
                      <button
                        id="saveFieldsBtn"
                        onclick="saveFieldEdits()"
                        class="btn btn-primary"
                      >
                        <i data-lucide="save" class="w-4 h-4"></i>
                        Save Changes
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </dialog>
          </div>

          <div id="createPage" class="hidden space-y-6">
            <!-- Clean Page Header -->
            <div class="text-center space-y-2">
              <h2 class="text-3xl font-bold">Create New Form</h2>
              <p class="text-neutral">
                Design a new placement opportunity form
              </p>
            </div>

            <!-- Form Creation Steps -->
            <div class="space-y-6">
              <!-- Step 1: Basic Details -->
              <div class="card bg-base-100 shadow">
                <div class="card-body p-6">
                  <div class="flex items-center gap-3 mb-6">
                    <div class="badge badge-primary">1</div>
                    <h3 class="text-xl font-bold">Basic Details</h3>
                  </div>

                  <div class="space-y-6">
                    <!-- Form Name -->
                    <div class="form-control w-full">
                      <label class="label">
                        <span class="label-text font-medium">Form Name</span>
                        <span class="label-text-alt">Unique identifier</span>
                      </label>
                      <input
                        type="text"
                        id="formName"
                        class="input input-bordered w-full"
                        placeholder="e.g., Google Software Engineer Internship 2025"
                        oninput="updateResponsePreview(this.value)"
                      />
                      <label class="label">
                        <span class="label-text-alt"
                          >Response sheet: Responses_<span
                            id="responsePreview"
                            class="font-bold"
                            >Your_Form_Name</span
                          ></span
                        >
                      </label>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                      <!-- Status -->
                      <div class="form-control w-full">
                        <label class="label">
                          <span class="label-text font-medium"
                            >Initial Status</span
                          >
                        </label>
                        <select
                          id="acceptingSelect"
                          class="select select-bordered w-full"
                        >
                          <option value="true">Open for Applications</option>
                          <option value="false">Closed (Draft Mode)</option>
                        </select>
                      </div>

                      <!-- Deadline -->
                      <div class="form-control w-full">
                        <label class="label">
                          <span class="label-text font-medium"
                            >Application Deadline</span
                          >
                          <span class="label-text-alt">Optional</span>
                        </label>
                        <input
                          type="datetime-local"
                          id="deadlineInput"
                          class="input input-bordered w-full"
                        />
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Step 2: Content -->
              <div class="card bg-base-100 shadow">
                <div class="card-body p-6">
                  <div class="flex items-center gap-3 mb-6">
                    <div class="badge badge-secondary">2</div>
                    <h3 class="text-xl font-bold">Form Content</h3>
                  </div>

                  <div class="space-y-6">
                    <!-- Description -->
                    <div class="form-control w-full">
                      <label class="label">
                        <span class="label-text font-medium"
                          >Job Description</span
                        >
                        <span class="label-text-alt"
                          >(Students will see this first)</span
                        >
                      </label>
                      <textarea
                        id="description"
                        class="textarea textarea-bordered h-32 w-full"
                        placeholder="Enter the job role description, requirements, and application instructions..."
                      ></textarea>
                    </div>

                    <!-- Resources -->
                    <div class="form-control w-full">
                      <label class="label">
                        <span class="label-text font-medium"
                          >Resources Link</span
                        >
                        <span class="label-text-alt">(Optional)</span>
                      </label>
                      <input
                        type="url"
                        id="fileLink"
                        class="input input-bordered w-full"
                        placeholder="https://drive.google.com/..."
                      />
                    </div>
                  </div>
                </div>
              </div>

              <!-- Step 3: Form Fields -->
              <div class="card bg-base-100 shadow">
                <div class="card-body p-6">
                  <div class="flex items-center gap-3 mb-6">
                    <div class="badge badge-accent">3</div>
                    <h3 class="text-xl font-bold">Form Fields</h3>
                  </div>

                  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Available Fields -->
                    <div class="card bg-base-200 border border-base-300">
                      <div class="card-body p-4">
                        <div class="space-y-3">
                          <h4 class="card-title text-base">
                            <i data-lucide="database" class="w-4 h-4"></i>
                            Available Fields
                          </h4>
                          <p class="text-sm text-neutral">
                            From student profiles
                          </p>
                          <div
                            id="availableList"
                            class="h-40 overflow-y-auto space-y-2 bg-base-100 p-3 rounded-lg"
                          ></div>
                        </div>
                      </div>
                    </div>

                    <!-- Selected Fields -->
                    <div class="card bg-base-200 border border-base-300">
                      <div class="card-body p-4">
                        <div class="space-y-3">
                          <h4 class="card-title text-base">
                            <i data-lucide="check-square" class="w-4 h-4"></i>
                            Form Fields
                          </h4>
                          <p class="text-sm text-neutral">Drag to reorder</p>
                          <div
                            id="selectedList"
                            class="h-40 overflow-y-auto space-y-2 bg-base-100 p-3 rounded-lg min-h-[100px]"
                          ></div>
                        </div>
                      </div>
                    </div>

                    <!-- Add Custom Field -->
                    <div class="card bg-base-200 border border-base-300">
                      <div class="card-body p-4">
                        <div class="space-y-3">
                          <h4 class="card-title text-base">
                            <i data-lucide="plus-square" class="w-4 h-4"></i>
                            Add Custom Field
                          </h4>

                          <div class="form-control w-full">
                            <label class="label">
                              <span class="label-text font-medium"
                                >Field Name</span
                              >
                            </label>
                            <input
                              type="text"
                              id="customFieldName"
                              class="input input-bordered input-sm w-full"
                              placeholder="Field Name"
                            />
                          </div>

                          <div class="form-control w-full">
                            <label class="label">
                              <span class="label-text font-medium"
                                >Field Type</span
                              >
                            </label>
                            <select
                              id="customFieldType"
                              class="select select-bordered select-sm w-full"
                            >
                              <option value="text">Text Input</option>
                              <option value="textarea">Long Text</option>
                              <option value="file">File Upload</option>
                              <option value="dropdown">Dropdown</option>
                              <option value="radio">Radio Buttons</option>
                            </select>
                          </div>

                          <div class="form-control w-full">
                            <label class="label">
                              <span class="label-text font-medium"
                                >Options</span
                              >
                              <span class="label-text-alt"
                                >Comma-separated</span
                              >
                            </label>
                            <input
                              type="text"
                              id="customFieldOptions"
                              class="input input-bordered input-sm w-full"
                              placeholder="Option 1, Option 2, Option 3"
                            />
                          </div>

                          <button
                            onclick="addCustomField()"
                            class="btn btn-primary btn-sm w-full mt-4"
                          >
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            Add Field
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Step 4: Student Access Control -->
              <div class="card bg-base-100 shadow">
                <div class="card-body p-6">
                  <div class="flex items-center gap-3 mb-6">
                    <div class="badge badge-neutral">4</div>
                    <div>
                      <h3 class="text-xl font-bold">Student Access Control</h3>
                      <p class="text-sm text-neutral">
                        Define who can see and apply to this form
                      </p>
                    </div>
                  </div>

                  <div class="bg-base-200 rounded-xl p-6">
                    <div id="createStudentSelector"></div>
                  </div>
                </div>
              </div>

              <!-- Step 5: Creation Actions -->
              <div class="card bg-base-100 shadow">
                <div class="card-body p-6">
                  <div
                    class="flex flex-col lg:flex-row items-center justify-between gap-6"
                  >
                    <div class="text-center lg:text-left">
                      <h4 class="text-xl font-bold mb-2">Ready to Launch?</h4>
                      <p class="text-sm text-neutral">
                        Review all settings and create your placement form
                      </p>
                    </div>

                    <div class="flex flex-col sm:flex-row gap-3">
                      <button onclick="resetCreateForm()" class="btn btn-ghost">
                        <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                        Reset Form
                      </button>
                      <button onclick="createForm()" class="btn btn-primary">
                        <i data-lucide="rocket" class="w-4 h-4"></i>
                        Create Placement Form
                      </button>
                    </div>
                  </div>

                  <!-- Create Message -->
                  <div id="createMessage" class="status-message mt-6"></div>

                  <!-- Success URL Display -->
                  <div
                    id="createdUrl"
                    class="hidden mt-6 p-4 bg-success/10 rounded-xl border border-success/20"
                  ></div>
                </div>
              </div>
            </div>
          </div>

          <div id="emailPage" class="hidden space-y-6">
            <!-- Page Header -->
            <div class="card bg-base-100 shadow">
              <div class="card-body p-6 text-center">
                <div class="flex items-center justify-center gap-3 mb-4">
                  <i data-lucide="mail" class="w-6 h-6 text-secondary"></i>
                  <h2 class="text-2xl font-bold">Student Communications</h2>
                </div>
                <p class="text-sm text-neutral max-w-2xl mx-auto">
                  Send placement notifications, form announcements, and updates
                  to students with advanced filtering capabilities
                </p>
              </div>
            </div>

            <!-- Compose Email -->
            <div class="card bg-base-100 shadow">
              <div class="card-body p-6">
                <div class="flex items-center gap-3 mb-6">
                  <div class="badge badge-primary badge-lg font-semibold">
                    1
                  </div>
                  <h3 class="text-lg font-semibold flex items-center gap-2">
                    <i data-lucide="edit" class="w-4 h-4 text-primary"></i>
                    Compose New Email
                  </h3>
                </div>

                <div class="space-y-6">
                  <!-- Form Selection -->
                  <div class="form-control w-full">
                    <label class="label-text font-medium mb-2 block">
                      <i data-lucide="folder" class="w-4 h-4 inline mr-2"></i>
                      Form Context
                    </label>
                    <select
                      id="emailFormSelect"
                      class="select select-bordered w-full"
                    >
                      <option value="">General announcement</option>
                    </select>
                    <div class="label">
                      <span class="label-text-alt text-neutral"
                        >Select a form to include context in email
                        templates</span
                      >
                    </div>
                  </div>

                  <!-- Subject -->
                  <div class="form-control w-full">
                    <label class="label-text font-medium mb-2 block">
                      <i data-lucide="mail" class="w-4 h-4 inline mr-2"></i>
                      Subject
                    </label>
                    <input
                      type="text"
                      id="emailSubject"
                      class="input input-bordered w-full"
                      placeholder="Enter email subject line..."
                    />
                    <div class="label">
                      <span class="label-text-alt text-neutral"
                        >This will appear in the student's inbox</span
                      >
                    </div>
                  </div>

                  <!-- Message -->
                  <div class="form-control w-full">
                    <label class="label-text font-medium mb-2 block">
                      <i
                        data-lucide="message-square"
                        class="w-4 h-4 inline mr-2"
                      ></i>
                      Message Content
                    </label>
                    <textarea
                      id="emailBody"
                      class="textarea textarea-bordered w-full h-32 resize-none"
                      placeholder="Write your email message here...&#10;&#10;You can use template variables like {{studentName}} for personalization."
                    ></textarea>
                    <div class="label">
                      <span class="label-text-alt text-neutral"
                        >Main content of your email - supports template
                        variables</span
                      >
                    </div>
                  </div>

                  <!-- Template Variables -->
                  <div class="bg-base-200 rounded-xl p-6">
                    <h5
                      class="font-medium text-sm mb-3 flex items-center gap-2"
                    >
                      <i data-lucide="braces" class="w-4 h-4 text-info"></i>
                      Available Template Variables
                    </h5>
                    <p class="text-xs text-neutral mb-4">
                      Click to copy and paste into your message
                    </p>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                      <button
                        class="bg-base-100 hover:bg-primary hover:text-primary-content px-3 py-2 rounded-lg text-xs font-mono transition-colors cursor-pointer border border-base-300"
                        onclick="copyToClipboard('{{formName}}')"
                      >
                        {{formName}}
                      </button>
                      <button
                        class="bg-base-100 hover:bg-primary hover:text-primary-content px-3 py-2 rounded-lg text-xs font-mono transition-colors cursor-pointer border border-base-300"
                        onclick="copyToClipboard('{{formLink}}')"
                      >
                        {{formLink}}
                      </button>
                      <button
                        class="bg-base-100 hover:bg-primary hover:text-primary-content px-3 py-2 rounded-lg text-xs font-mono transition-colors cursor-pointer border border-base-300"
                        onclick="copyToClipboard('{{studentName}}')"
                      >
                        {{studentName}}
                      </button>
                      <button
                        class="bg-base-100 hover:bg-primary hover:text-primary-content px-3 py-2 rounded-lg text-xs font-mono transition-colors cursor-pointer border border-base-300"
                        onclick="copyToClipboard('{{deadline}}')"
                      >
                        {{deadline}}
                      </button>
                    </div>
                  </div>

                  <!-- Additional Options -->
                  <div class="bg-base-200 rounded-xl p-6">
                    <h5
                      class="font-medium text-sm mb-4 flex items-center gap-2"
                    >
                      <i
                        data-lucide="settings"
                        class="w-4 h-4 text-secondary"
                      ></i>
                      Email Options
                    </h5>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                      <div class="form-control">
                        <label
                          class="cursor-pointer label justify-start gap-3 p-0"
                        >
                          <input
                            type="checkbox"
                            id="emailUseReplyTo"
                            class="checkbox checkbox-primary"
                          />
                          <div class="flex flex-col">
                            <span class="label-text font-medium"
                              >Custom Reply-To</span
                            >
                            <span class="label-text-alt text-neutral text-xs"
                              >Allow students to reply directly to you</span
                            >
                          </div>
                        </label>
                      </div>
                      <div class="form-control w-full">
                        <label class="label-text font-medium mb-2 block">
                          <i data-lucide="user" class="w-4 h-4 inline mr-2"></i>
                          Sender Name
                        </label>
                        <input
                          type="text"
                          id="emailSenderName"
                          class="input input-bordered w-full"
                          placeholder="Your name (optional)"
                        />
                        <div class="label">
                          <span class="label-text-alt text-neutral"
                            >How your name will appear to students</span
                          >
                        </div>
                      </div>
                    </div>
                  </div>
                  <!-- Send Controls -->
                  <div
                    class="bg-warning/10 rounded-xl p-6 border border-warning/20"
                  >
                    <div
                      class="flex flex-col sm:flex-row gap-4 justify-between items-start sm:items-center"
                    >
                      <div class="flex items-start gap-3">
                        <i
                          data-lucide="alert-triangle"
                          class="w-5 h-5 text-warning mt-0.5"
                        ></i>
                        <div>
                          <h5 class="font-medium text-sm text-warning mb-1">
                            Review Before Sending
                          </h5>
                          <p class="text-sm text-neutral">
                            Double-check your message content and recipient list
                          </p>
                        </div>
                      </div>
                      <div class="flex gap-3 w-full sm:w-auto">
                        <button
                          onclick="resetEmailForm()"
                          class="btn btn-ghost flex-1 sm:flex-none"
                        >
                          <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                          Reset Form
                        </button>
                        <button
                          onclick="sendEmails()"
                          class="btn btn-primary flex-1 sm:flex-none"
                        >
                          <i data-lucide="send" class="w-4 h-4"></i>
                          Send Emails
                        </button>
                      </div>
                    </div>
                </div>
              </div>
            </div>

            <!-- Email Forwarding -->
            <div class="card bg-base-100 shadow">
              <div class="card-body p-6">
                <div class="flex items-center gap-3 mb-6">
                  <div class="badge badge-secondary badge-lg font-semibold">
                    2
                  </div>
                  <h3 class="text-lg font-semibold flex items-center gap-2">
                    <i data-lucide="forward" class="w-4 h-4 text-secondary"></i>
                    Forward from Inbox
                  </h3>
                </div>

                <div class="space-y-6">
                  <div
                    class="bg-accent/10 rounded-xl p-4 border border-accent/20"
                  >
                    <div class="flex items-start gap-3">
                      <i
                        data-lucide="info"
                        class="w-5 h-5 text-accent mt-0.5"
                      ></i>
                      <div>
                        <h5 class="font-medium text-sm text-accent mb-1">
                          Forward Existing Emails
                        </h5>
                        <p class="text-sm text-neutral">
                          Search and forward existing emails from your Gmail
                          inbox to selected students
                        </p>
                      </div>
                    </div>
                  </div>

                  <!-- Email Search -->
                  <div class="form-control w-full">
                    <label class="label-text font-medium mb-2 block">
                      <i data-lucide="search" class="w-4 h-4 inline mr-2"></i>
                      Search Your Gmail Inbox
                    </label>
                    <div class="join w-full">
                      <input
                        type="text"
                        id="emailSearchTerm"
                        class="input input-bordered join-item flex-1"
                        placeholder="Enter keywords, sender name, or subject..."
                      />
                      <button
                        id="findEmailBtn"
                        onclick="findEmail()"
                        class="btn btn-primary join-item"
                      >
                        <i data-lucide="search" class="w-4 h-4"></i>
                        Search
                      </button>
                    </div>
                    <div class="label">
                      <span class="label-text-alt text-neutral"
                        >Search through your recent emails to find content to
                        forward</span
                      >
                    </div>
                  </div>

                  <!-- Search Results -->
                  <div class="form-control w-full">
                    <label class="label-text font-medium mb-2 block">
                      <i data-lucide="inbox" class="w-4 h-4 inline mr-2"></i>
                      Search Results
                    </label>
                    <div
                      id="emailSearchResults"
                      class="bg-base-200 rounded-xl p-6 min-h-[120px]"
                    >
                      <div
                        class="flex flex-col items-center justify-center py-8 text-center"
                      >
                        <i
                          data-lucide="mail-search"
                          class="w-12 h-12 text-neutral mb-3"
                        ></i>
                        <p class="text-neutral font-medium">
                          No search performed yet
                        </p>
                        <p class="text-sm text-neutral/70">
                          Use the search above to find emails to forward
                        </p>
                      </div>
                    </div>
                  </div>

                  <!-- Forward Compose Area -->
                  <div id="forwardComposeArea" class="hidden">
                    <div class="form-control w-full">
                      <label class="label-text font-medium mb-2 block">
                        <i data-lucide="edit-3" class="w-4 h-4 inline mr-2"></i>
                        Additional Message (Optional)
                      </label>
                      <div class="bg-success/10 rounded-xl p-4 border border-success/20 mb-4">
                        <div class="flex items-start gap-3">
                          <i data-lucide="forward" class="w-5 h-5 text-success mt-0.5"></i>
                          <div>
                            <h5 class="font-medium text-sm text-success mb-1">
                              Forwarding:
                              <span id="forwardSubject" class="font-normal text-base-content">(No Subject Selected)</span>
                            </h5>
                            <p class="text-sm text-neutral">
                              The original email will be forwarded below your message.
                            </p>
                          </div>
                        </div>
                      </div>
                      <input type="hidden" id="forwardMessageId" />
                      <textarea
                        id="forwardMessage"
                        class="textarea textarea-bordered w-full h-24 resize-none"
                        placeholder="Add your introductory message here (optional)...&#10;&#10;The forwarded email content will appear below this message."
                      ></textarea>
                      <div class="label">
                        <span class="label-text-alt text-neutral">Your message will appear before the forwarded content</span>
                      </div>
                      <button onclick="sendForwardedEmail()" class="btn btn-secondary mt-4 w-full sm:w-auto self-end">
                        <i data-lucide="send" class="w-4 h-4"></i>
                        Forward Email to Selected Students
                      </button>
                      </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Student Filtering -->
            <div class="card bg-base-100 shadow">
              <div class="card-body p-6">
                <div class="flex items-center gap-3 mb-6">
                  <div class="badge badge-accent badge-lg font-semibold">3</div>
                  <h3 class="text-lg font-semibold flex items-center gap-2">
                    <i data-lucide="filter" class="w-4 h-4 text-accent"></i>
                    Select Recipients
                  </h3>
                </div>

                <div class="space-y-6">
                  <!-- Filter Controls -->
                  <div class="bg-base-200 rounded-xl p-6">
                    <h5
                      class="font-medium text-sm mb-4 flex items-center gap-2"
                    >
                      <i
                        data-lucide="sliders-horizontal"
                        class="w-4 h-4 text-info"
                      ></i>
                      Filter Students
                    </h5>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                      <div class="form-control w-full">
                        <label class="label-text font-medium mb-2 block">
                          Filter Field
                        </label>
                        <select
                          id="filterFieldSelect"
                          class="select select-bordered w-full"
                        >
                          <option value="">All students</option>
                        </select>
                      </div>
                      <div class="form-control w-full">
                        <label class="label-text font-medium mb-2 block">
                          Filter Value
                        </label>
                        <input
                          type="text"
                          id="filterValueInput"
                          class="input input-bordered w-full"
                          placeholder="Enter filter criteria..."
                        />
                      </div>
                      <div class="form-control w-full">
                        <label class="label-text font-medium mb-2 block">
                          Action
                        </label>
                        <button
                          onclick="applyStudentFilter()"
                          class="btn btn-accent w-full"
                        >
                          <i data-lucide="filter" class="w-4 h-4"></i>
                          Apply Filter
                        </button>
                      </div>
                    </div>
                    <div class="mt-3">
                      <span class="label-text-alt text-neutral"
                        >Use filters like ">=8.5" for CGPA, "CSE" for branch, or
                        "*gmail.com" for email domains</span
                      >
                    </div>
                  </div>

                  <!-- Selection Summary -->
                  <div
                    class="flex flex-wrap gap-4 items-center justify-between bg-base-200 rounded-xl p-4"
                  >
                    <div class="flex items-center gap-4">
                      <label class="cursor-pointer flex items-center gap-2">
                        <input
                          type="checkbox"
                          id="selectAllStudents"
                          onchange="handleSelectAll('emailPage', this)"
                          class="checkbox checkbox-primary"
                        />
                        <span class="label-text font-medium"
                          >Select All Visible</span
                        >
                      </label>
                      <div class="divider divider-horizontal"></div>
                      <div class="flex items-center gap-2">
                        <i data-lucide="users" class="w-4 h-4 text-primary"></i>
                        <span class="font-mono font-bold text-primary"
                          ><span id="studentListCount">0</span> selected</span
                        >
                      </div>
                    </div>
                    <div class="text-sm text-neutral flex items-center gap-2">
                      <i data-lucide="shield-check" class="w-4 h-4"></i>
                      Ready to send
                    </div>
                  </div>

                  <!-- Student List -->
                  <div class="form-control w-full">
                    <label class="label-text font-medium mb-2 block">
                      <i data-lucide="list" class="w-4 h-4 inline mr-2"></i>
                      Student List
                    </label>
                    <div
                      class="bg-base-200 rounded-xl p-6 max-h-80 overflow-y-auto border border-base-300"
                    >
                      <div id="studentList" class="space-y-2">
                        <div
                          class="flex flex-col items-center justify-center py-8 text-center"
                        >
                          <div
                            class="loading loading-dots loading-md text-primary mb-3"
                          ></div>
                          <p class="text-neutral font-medium">
                            Loading students...
                          </p>
                          <p class="text-sm text-neutral/70">
                            Please wait while we fetch the student data
                          </p>
                        </div>
                      </div>
                    </div>
                    <div class="label">
                      <span class="label-text-alt text-neutral"
                        >Select individual students or use filters to narrow
                        down recipients</span
                      >
                    </div>
                  </div>


                  </div>

                  <div id="emailMessage" class="status-message"></div>
                </div>
              </div>
            </div>
          </div>

          <div id="studentsPage" class="hidden space-y-6">
            <!-- Page Header -->
            <div class="card bg-base-100 shadow">
              <div class="card-body p-6 text-center">
                <div class="flex items-center justify-center gap-3 mb-4">
                  <i data-lucide="users" class="w-6 h-6 text-accent"></i>
                  <h2 class="text-2xl font-bold">Student Data Management</h2>
                </div>
                <p class="text-sm text-neutral max-w-2xl mx-auto">
                  Manage student records, upload bulk data, and configure
                  profile editing permissions
                </p>
              </div>
            </div>

            <!-- Bulk CSV Upload -->
            <div class="card bg-base-100 shadow">
              <div class="card-body p-6">
                <div class="flex items-center gap-3 mb-6">
                  <div class="badge badge-primary badge-lg font-semibold">
                    1
                  </div>
                  <h3 class="text-lg font-semibold flex items-center gap-2">
                    <i data-lucide="upload" class="w-4 h-4 text-primary"></i>
                    Bulk CSV Upload
                  </h3>
                </div>

                <div class="space-y-6">
                  <!-- CSV File Upload -->
                  <div class="form-control w-full">
                    <label class="label-text font-medium mb-2 block">
                      <i
                        data-lucide="file-spreadsheet"
                        class="w-4 h-4 inline mr-2"
                      ></i>
                      CSV File Upload
                    </label>
                    
                    <!-- File Upload Dropzone -->
                    <div 
                      id="csvDropzone" 
                      class="border-2 border-dashed border-base-300 rounded-xl p-8 text-center transition-all duration-300 hover:border-primary hover:bg-base-50 cursor-pointer"
                      ondrop="handleDrop(event)" 
                      ondragover="handleDragOver(event)" 
                      ondragleave="handleDragLeave(event)"
                      onclick="document.getElementById('csvFileInput').click()"
                    >
                      <div id="dropzoneContent">
                        <div class="flex flex-col items-center gap-4">
                          <div class="w-16 h-16 bg-base-200 rounded-full flex items-center justify-center">
                            <i data-lucide="upload-cloud" class="w-8 h-8 text-base-content/60"></i>
                          </div>
                          <div>
                            <p class="text-base font-medium text-base-content mb-1">
                              Drop your CSV file here or click to browse
                            </p>
                            <p class="text-sm text-base-content/60">
                              Supports .csv files up to 10MB
                            </p>
                          </div>
                          <div class="flex items-center gap-2 text-xs text-base-content/40">
                            <i data-lucide="shield-check" class="w-3 h-3"></i>
                            <span>Secure file processing</span>
                          </div>
                        </div>
                      </div>
                      
                      <!-- File Preview Area (hidden by default) -->
                      <div id="filePreview" class="hidden">
                        <div class="bg-base-100 rounded-lg p-4 border border-base-200">
                          <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-3">
                              <div class="w-10 h-10 bg-success/10 rounded-lg flex items-center justify-center">
                                <i data-lucide="file-text" class="w-5 h-5 text-success"></i>
                              </div>
                              <div>
                                <p id="fileName" class="font-medium text-sm"></p>
                                <p id="fileSize" class="text-xs text-base-content/60"></p>
                              </div>
                            </div>
                            <button 
                              type="button"
                              onclick="clearFile()"
                              class="btn btn-ghost btn-sm btn-circle"
                            >
                              <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                          </div>
                          <div class="text-xs text-base-content/60">
                            <i data-lucide="check-circle" class="w-3 h-3 inline mr-1"></i>
                            Ready to upload
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Hidden file input -->
                    <input 
                      type="file" 
                      id="csvFileInput" 
                      accept=".csv,.txt" 
                      style="display: none;"
                      onchange="handleFileSelect(event)"
                    />
                    
                    <!-- Hidden textarea for CSV data (maintains compatibility) -->
                    <textarea 
                      id="csvDataInput" 
                      style="display: none;"
                    ></textarea>
                    
                    <div class="label">
                      <span class="label-text-alt text-neutral"
                        >First row must contain column headers</span
                      >
                    </div>
                  </div>

                  <!-- Upload Actions -->
                  <div class="flex flex-col sm:flex-row gap-3">
                    <button
                      id="csvUploadBtn"
                      onclick="processCsvUpload()"
                      class="btn btn-primary flex-1 sm:flex-none"
                      disabled
                    >
                      <span
                        class="hidden loading loading-spinner loading-xs"
                      ></span>
                      <i data-lucide="upload" class="w-4 h-4"></i>
                      Process Upload
                    </button>
                    <button
                      onclick="clearFile()"
                      class="btn btn-ghost flex-1 sm:flex-none"
                    >
                      <i data-lucide="x" class="w-4 h-4"></i>
                      Clear File
                    </button>
                  </div>

                  <!-- Upload Guide -->
                  <div class="bg-base-200 rounded-xl p-6">
                    <h5
                      class="font-medium text-sm mb-3 flex items-center gap-2"
                    >
                      <i
                        data-lucide="check-circle"
                        class="w-4 h-4 text-success"
                      ></i>
                      CSV File Requirements
                    </h5>
                    <ul class="text-sm space-y-2 text-neutral">
                      <li class="flex items-start gap-2">
                        <i data-lucide="dot" class="w-3 h-3 mt-1"></i>
                        Upload a .csv file or drag and drop into the area above
                      </li>
                      <li class="flex items-start gap-2">
                        <i data-lucide="dot" class="w-3 h-3 mt-1"></i>
                        First row must contain column headers
                      </li>
                      <li class="flex items-start gap-2">
                        <i data-lucide="dot" class="w-3 h-3 mt-1"></i>
                        Required columns: RollNo, Name, Email
                      </li>
                      <li class="flex items-start gap-2">
                        <i data-lucide="dot" class="w-3 h-3 mt-1"></i>
                        Optional: CGPA, Department, Phone, etc.
                      </li>
                      <li class="flex items-start gap-2">
                        <i data-lucide="dot" class="w-3 h-3 mt-1"></i>
                        Passwords will be auto-generated if not provided
                      </li>
                    </ul>
                  </div>

                  <div id="csvMessage" class="status-message"></div>
                </div>
              </div>
            </div>

            <!-- Individual Student Management -->
            <div class="card bg-base-100 shadow">
              <div class="card-body p-6">
                <div class="flex items-center gap-3 mb-6">
                  <div class="badge badge-secondary badge-lg font-semibold">
                    2
                  </div>
                  <h3 class="text-lg font-semibold flex items-center gap-2">
                    <i
                      data-lucide="user-search"
                      class="w-4 h-4 text-secondary"
                    ></i>
                    Individual Student Management
                  </h3>
                </div>

                <div class="space-y-6">
                  <!-- Student Search -->
                  <div class="form-control w-full">
                    <label class="label-text font-medium mb-2 block">
                      <i data-lucide="search" class="w-4 h-4 inline mr-2"></i>
                      Search Student
                    </label>
                    <div class="join w-full">
                      <input
                        type="text"
                        id="studentSearchInput"
                        class="input input-bordered join-item flex-1"
                        placeholder="Enter Roll No, Name, or Email address..."
                      />
                      <button
                        id="searchStudentBtn"
                        onclick="searchStudent()"
                        class="btn btn-primary join-item"
                      >
                        <i data-lucide="search" class="w-4 h-4"></i>
                        Search
                      </button>
                    </div>
                    <div class="label">
                      <span class="label-text-alt text-neutral"
                        >Find students to view or edit their information</span
                      >
                    </div>
                  </div>

                  <!-- Search Results -->
                  <div class="form-control w-full">
                    <label class="label-text font-medium mb-2 block">
                      <i data-lucide="users" class="w-4 h-4 inline mr-2"></i>
                      Search Results
                    </label>
                    <div
                      id="studentSearchResults"
                      class="bg-base-200 rounded-xl p-6 min-h-[120px]"
                    >
                      <div
                        class="flex flex-col items-center justify-center py-8 text-center"
                      >
                        <i
                          data-lucide="user-search"
                          class="w-12 h-12 text-neutral mb-3"
                        ></i>
                        <p class="text-neutral font-medium">
                          No search performed yet
                        </p>
                        <p class="text-sm text-neutral/70">
                          Use the search above to find student records
                        </p>
                      </div>
                    </div>
                  </div>

                  <!-- Student Edit Form -->
                  <div id="studentEditForm" class="hidden">
                    <div class="form-control w-full">
                      <label class="label-text font-medium mb-2 block">
                        <i data-lucide="edit" class="w-4 h-4 inline mr-2"></i>
                        Edit Student Information
                      </label>
                      <div class="bg-base-200 rounded-xl p-6 space-y-6">
                        <!-- Student Info Header -->
                        <div
                          class="bg-primary/10 rounded-xl p-4 border border-primary/20"
                        >
                          <div class="flex items-start gap-3">
                            <i
                              data-lucide="user"
                              class="w-5 h-5 text-primary mt-0.5"
                            ></i>
                            <div>
                              <h5 class="font-medium text-sm text-primary mb-1">
                                Currently Editing
                              </h5>
                              <p
                                class="text-sm font-semibold text-base-content"
                              >
                                <span id="editingStudentName"
                                  >Student Name</span
                                >
                              </p>
                            </div>
                          </div>
                        </div>

                        <input type="hidden" id="editingStudentRollNo" />

                        <!-- Dynamic Fields Container -->
                        <div
                          class="grid grid-cols-1 md:grid-cols-2 gap-6"
                          id="studentEditFields"
                        >
                          <!-- Dynamic fields will be populated here -->
                        </div>

                        <!-- Action Buttons -->
                        <div
                          class="bg-warning/10 rounded-xl p-4 border border-warning/20"
                        >
                          <div
                            class="flex flex-col sm:flex-row gap-3 justify-between items-start sm:items-center"
                          >
                            <div class="flex items-start gap-3">
                              <i
                                data-lucide="alert-triangle"
                                class="w-5 h-5 text-warning mt-0.5"
                              ></i>
                              <div>
                                <h5
                                  class="font-medium text-sm text-warning mb-1"
                                >
                                  Review Before Saving
                                </h5>
                                <p class="text-sm text-neutral">
                                  Double-check all changes before saving
                                </p>
                              </div>
                            </div>
                            <div class="flex gap-3 w-full sm:w-auto">
                              <button
                                onclick="hideStudentEditForm()"
                                class="btn btn-ghost flex-1 sm:flex-none"
                              >
                                <i data-lucide="x" class="w-4 h-4"></i>
                                Cancel
                              </button>
                              <button
                                onclick="saveStudentChanges()"
                                class="btn btn-primary flex-1 sm:flex-none"
                              >
                                <i data-lucide="save" class="w-4 h-4"></i>
                                Save Changes
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div id="studentMessage" class="status-message"></div>
                </div>
              </div>
            </div>

            <!-- Student Profile Configuration -->
            <div class="card bg-base-100 shadow">
              <div class="card-body p-6">
                <div class="flex items-center gap-3 mb-6">
                  <div class="badge badge-accent badge-lg font-semibold">3</div>
                  <h3 class="text-lg font-semibold flex items-center gap-2">
                    <i data-lucide="settings" class="w-4 h-4 text-accent"></i>
                    Student Profile Configuration
                  </h3>
                </div>

                <div class="space-y-6">
                  <!-- Information Banner -->
                  <div class="bg-info/10 rounded-xl p-4 border border-info/20">
                    <div class="flex items-start gap-3">
                      <i
                        data-lucide="info"
                        class="w-5 h-5 text-info mt-0.5"
                      ></i>
                      <div>
                        <h5 class="font-medium text-sm text-info mb-1">
                          Student Profile Permissions
                        </h5>
                        <p class="text-sm text-neutral">
                          Configure which profile fields students can edit
                          themselves when they log in
                        </p>
                      </div>
                    </div>
                  </div>

                  <!-- Field Selector -->
                  <div class="form-control w-full">
                    <label class="label-text font-medium mb-2 block">
                      <i data-lucide="sliders" class="w-4 h-4 inline mr-2"></i>
                      Available Profile Fields
                    </label>
                    <div
                      id="studentProfileSelector"
                      class="bg-base-200 rounded-xl p-6"
                    >
                      <div
                        class="flex flex-col items-center justify-center py-8 text-center"
                      >
                        <div
                          class="loading loading-dots loading-md text-primary mb-3"
                        ></div>
                        <p class="text-neutral font-medium">
                          Loading profile fields...
                        </p>
                        <p class="text-sm text-neutral/70">
                          Please wait while we fetch the available options
                        </p>
                      </div>
                    </div>
                    <div class="label">
                      <span class="label-text-alt text-neutral"
                        >Toggle fields that students should be able to
                        edit</span
                      >
                    </div>
                  </div>

                  <!-- Current Configuration -->
                  <div class="form-control w-full">
                    <label class="label-text font-medium mb-2 block">
                      <i
                        data-lucide="check-square"
                        class="w-4 h-4 inline mr-2"
                      ></i>
                      Current Configuration
                    </label>
                    <div
                      id="studentProfileConfigList"
                      class="bg-base-200 rounded-xl p-6 min-h-[120px]"
                    >
                      <div
                        class="flex flex-col items-center justify-center py-8 text-center"
                      >
                        <div
                          class="loading loading-dots loading-md text-primary mb-3"
                        ></div>
                        <p class="text-neutral font-medium">
                          Loading configuration...
                        </p>
                        <p class="text-sm text-neutral/70">
                          Fetching current field permissions
                        </p>
                      </div>
                    </div>
                  </div>

                  <!-- Action Buttons -->
                  <div
                    class="bg-accent/10 rounded-xl p-6 border border-accent/20"
                  >
                    <div
                      class="flex flex-col sm:flex-row gap-4 justify-between items-start sm:items-center"
                    >
                      <div class="flex items-start gap-3">
                        <i
                          data-lucide="shield-check"
                          class="w-5 h-5 text-accent mt-0.5"
                        ></i>
                        <div>
                          <h5 class="font-medium text-sm text-accent mb-1">
                            Save Configuration
                          </h5>
                          <p class="text-sm text-neutral">
                            Apply changes to student profile permissions
                          </p>
                        </div>
                      </div>
                      <div class="flex gap-3 w-full sm:w-auto">
                        <button
                          onclick="loadStudentProfileConfig()"
                          class="btn btn-ghost flex-1 sm:flex-none"
                        >
                          <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                          Reload
                        </button>
                        <button
                          onclick="saveStudentProfileConfig()"
                          class="btn btn-primary flex-1 sm:flex-none"
                        >
                          <i data-lucide="save" class="w-4 h-4"></i>
                          Save Configuration
                        </button>
                      </div>
                    </div>
                  </div>

                  <div id="profileConfigMessage" class="status-message"></div>
                  <div id="studentConfigMessage" class="status-message"></div>
                </div>
              </div>
            </div>
          </div>

          <div id="rbacPage" class="hidden space-y-6">
            <!-- Page Header -->
            <div class="card bg-base-100 shadow">
              <div class="card-body p-6 text-center">
                <div class="flex items-center justify-center gap-3 mb-4">
                  <i
                    data-lucide="shield-check"
                    class="w-6 h-6 text-warning"
                  ></i>
                  <h2 class="text-2xl font-bold">Admin Role Management</h2>
                </div>
                <p class="text-sm text-neutral max-w-2xl mx-auto">
                  Manage administrator access levels and permissions with
                  role-based access control
                </p>
              </div>
            </div>

            <!-- RBAC Management -->
            <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
              <!-- Current Admins List -->
              <div class="xl:col-span-2">
                <div class="card bg-base-100 shadow">
                  <div class="card-body p-6">
                    <div class="flex items-center gap-3 mb-6">
                      <div class="badge badge-primary badge-lg font-semibold">
                        1
                      </div>
                      <h3 class="text-lg font-semibold flex items-center gap-2">
                        <i
                          data-lucide="users-cog"
                          class="w-4 h-4 text-primary"
                        ></i>
                        Current Administrators
                      </h3>
                    </div>

                    <div class="space-y-6">
                      <!-- Admin Table -->
                      <div class="bg-base-200 rounded-xl overflow-hidden">
                        <div class="overflow-x-auto">
                          <table class="table table-zebra w-full">
                            <thead class="bg-base-200/50">
                              <tr>
                                <th
                                  class="text-left p-4 font-semibold flex items-center gap-2"
                                >
                                  <i
                                    data-lucide="mail"
                                    class="w-5 h-5 text-black"
                                  ></i>
                                  Email Address
                                </th>
                                <th class="text-left p-4 font-semibold">
                                  <div class="flex items-center gap-2">
                                    <i
                                      data-lucide="shield"
                                      class="w-4 h-4 text-warning"
                                    ></i>
                                    Role
                                  </div>
                                </th>
                                <th class="text-center p-4 font-semibold">
                                  <div
                                    class="flex items-center justify-center gap-2"
                                  >
                                    <i
                                      data-lucide="settings"
                                      class="w-4 h-4 text-secondary"
                                    ></i>
                                    Actions
                                  </div>
                                </th>
                              </tr>
                            </thead>
                            <tbody
                              id="rbacTbody"
                              class="divide-y divide-base-300/50"
                            >
                              <tr>
                                <td
                                  colspan="3"
                                  class="text-center py-12 text-neutral"
                                >
                                  <i
                                    data-lucide="user-search"
                                    class="w-12 h-12 mx-auto mb-2 text-neutral"
                                  ></i>
                                  <p class="text-sm">
                                    Loading administrators...
                                  </p>
                                </td>
                              </tr>
                            </tbody>
                          </table>
                        </div>
                      </div>

                      <!-- Role Permissions Info -->
                      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-base-200 p-6 rounded-xl">
                          <div class="flex items-center gap-2 mb-2">
                            <i data-lucide="eye" class="w-4 h-4 text-info"></i>
                            <span class="font-semibold text-sm">Viewer</span>
                          </div>
                          <p class="text-xs text-neutral">
                            Read-only access to forms and data
                          </p>
                        </div>
                        <div class="bg-base-200 p-6 rounded-xl">
                          <div class="flex items-center gap-2 mb-2">
                            <i
                              data-lucide="edit"
                              class="w-4 h-4 text-success"
                            ></i>
                            <span class="font-semibold text-sm">Editor</span>
                          </div>
                          <p class="text-xs text-neutral">
                            Can create/edit forms and send emails
                          </p>
                        </div>
                        <div class="bg-base-200 p-6 rounded-xl">
                          <div class="flex items-center gap-2 mb-2">
                            <i
                              data-lucide="crown"
                              class="w-4 h-4 text-warning"
                            ></i>
                            <span class="font-semibold text-sm"
                              >SuperAdmin</span
                            >
                          </div>
                          <p class="text-xs text-neutral">
                            Full system access including user management
                          </p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Role Assignment Panel -->
              <div>
                <div class="card bg-base-100 shadow">
                  <div class="card-body p-6">
                    <div class="flex items-center gap-3 mb-6">
                      <div class="badge badge-secondary badge-lg font-semibold">
                        2
                      </div>
                      <h3 class="text-lg font-semibold flex items-center gap-2">
                        <i
                          data-lucide="user-plus"
                          class="w-4 h-4 text-secondary"
                        ></i>
                        Assign Role
                      </h3>
                    </div>

                    <div class="space-y-6">
                      <!-- Email Input -->
                      <div class="form-control w-full">
                        <label class="label">
                          <span
                            class="label-text font-medium flex items-center gap-2"
                          >
                            <i
                              data-lucide="at-sign"
                              class="w-4 h-4 text-accent"
                            ></i>
                            Email Address
                          </span>
                        </label>
                        <input
                          type="email"
                          id="rbacEmail"
                          placeholder="user@example.com"
                          class="input input-bordered"
                        />
                        <label class="label">
                          <span class="label-text-alt"
                            >Enter the user's email address</span
                          >
                        </label>
                      </div>

                      <!-- Role Selection -->
                      <div class="form-control w-full">
                        <label class="label">
                          <span
                            class="label-text font-medium flex items-center gap-2"
                          >
                            <i
                              data-lucide="shield-check"
                              class="w-5 h-5 text-black"
                            ></i>
                            Admin Role
                          </span>
                        </label>
                        <select
                          id="rbacRoleSelect"
                          class="select select-bordered"
                        >
                          <option value="Viewer">
                            <i
                              data-lucide="eye"
                              class="w-4 h-4 inline mr-2"
                            ></i>
                            Viewer - Read Only
                          </option>
                          <option value="Editor">
                            <i
                              data-lucide="edit"
                              class="w-4 h-4 inline mr-2"
                            ></i>
                            Editor - Can Create & Edit
                          </option>
                          <option value="SuperAdmin">
                            <i
                              data-lucide="crown"
                              class="w-4 h-4 inline mr-2"
                            ></i>
                            SuperAdmin - Full Access
                          </option>
                          <option value="Guest">
                            <i
                              data-lucide="user-x"
                              class="w-4 h-4 inline mr-2"
                            ></i>
                            Guest - Remove Access
                          </option>
                        </select>
                        <label class="label">
                          <span class="label-text-alt"
                            >Select the appropriate access level</span
                          >
                        </label>
                      </div>

                      <!-- Security Warning -->
                      <div
                        class="bg-base-200 p-6 rounded-xl border border-warning/20"
                      >
                        <div class="flex items-start gap-3">
                          <i
                            data-lucide="alert-triangle"
                            class="w-5 h-5 text-warning mt-0.5"
                          ></i>
                          <div>
                            <h5 class="font-semibold text-sm text-warning mb-1">
                              Security Notice
                            </h5>
                            <p class="text-xs text-neutral">
                              SuperAdmin role grants full system access
                              including user management. Only assign to trusted
                              administrators.
                            </p>
                          </div>
                        </div>
                      </div>

                      <!-- Action Button -->
                      <button
                        id="setRoleBtn"
                        onclick="setAdminRoleUI()"
                        class="btn btn-primary btn-block"
                      >
                        <i data-lucide="user-check" class="w-4 h-4"></i>
                        Set Admin Role
                      </button>

                      <div id="rbacResult" class="status-message"></div>

                      <!-- Actions -->
                      <div class="pt-6 border-t border-base-300">
                        <div class="space-y-2">
                          <button
                            class="btn btn-ghost btn-sm w-full justify-start"
                            onclick="document.getElementById('rbacRoleSelect').value='Guest'; document.getElementById('setRoleBtn').click();"
                          >
                            <i
                              data-lucide="user-minus"
                              class="w-4 h-4 text-error"
                            ></i>
                            Remove Admin Access
                          </button>
                          <button
                            class="btn btn-ghost btn-sm w-full justify-start"
                            onclick="location.reload();"
                          >
                            <i
                              data-lucide="refresh-cw"
                              class="w-4 h-4 text-info"
                            ></i>
                            Refresh Admin List
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Role Hierarchy Explanation -->
            <div class="card bg-base-100 shadow">
              <div class="card-body p-6">
                <h3 class="text-lg font-semibold flex items-center gap-2 mb-6">
                  <i data-lucide="info" class="w-4 h-4 text-info"></i>
                  Role-Based Access Control (RBAC) Overview
                </h3>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  <!-- Permissions Matrix -->
                  <div>
                    <h4 class="font-semibold mb-3 flex items-center gap-2">
                      <i
                        data-lucide="grid-3x3"
                        class="w-4 h-4 text-primary"
                      ></i>
                      Permissions Matrix
                    </h4>
                    <div class="bg-base-200 rounded-xl overflow-hidden">
                      <table class="table table-sm w-full">
                        <thead class="bg-base-200/50">
                          <tr>
                            <th class="font-semibold">Feature</th>
                            <th class="text-center font-semibold">Viewer</th>
                            <th class="text-center font-semibold">Editor</th>
                            <th class="text-center font-semibold">
                              SuperAdmin
                            </th>
                          </tr>
                        </thead>
                        <tbody class="divide-y divide-base-300/30">
                          <tr>
                            <td class="text-sm">View Forms & Data</td>
                            <td class="text-center">
                              <i
                                data-lucide="check"
                                class="w-4 h-4 text-success"
                              ></i>
                            </td>
                            <td class="text-center">
                              <i
                                data-lucide="check"
                                class="w-4 h-4 text-success"
                              ></i>
                            </td>
                            <td class="text-center">
                              <i
                                data-lucide="check"
                                class="w-4 h-4 text-success"
                              ></i>
                            </td>
                          </tr>
                          <tr>
                            <td class="text-sm">Create/Edit Forms</td>
                            <td class="text-center">
                              <i data-lucide="x" class="w-4 h-4 text-error"></i>
                            </td>
                            <td class="text-center">
                              <i
                                data-lucide="check"
                                class="w-4 h-4 text-success"
                              ></i>
                            </td>
                            <td class="text-center">
                              <i
                                data-lucide="check"
                                class="w-4 h-4 text-success"
                              ></i>
                            </td>
                          </tr>
                          <tr>
                            <td class="text-sm">Send Emails</td>
                            <td class="text-center">
                              <i data-lucide="x" class="w-4 h-4 text-error"></i>
                            </td>
                            <td class="text-center">
                              <i
                                data-lucide="check"
                                class="w-4 h-4 text-success"
                              ></i>
                            </td>
                            <td class="text-center">
                              <i
                                data-lucide="check"
                                class="w-4 h-4 text-success"
                              ></i>
                            </td>
                          </tr>
                          <tr>
                            <td class="text-sm">Manage Students</td>
                            <td class="text-center">
                              <i data-lucide="x" class="w-4 h-4 text-error"></i>
                            </td>
                            <td class="text-center">
                              <i data-lucide="x" class="w-4 h-4 text-error"></i>
                            </td>
                            <td class="text-center">
                              <i
                                data-lucide="check"
                                class="w-4 h-4 text-success"
                              ></i>
                            </td>
                          </tr>
                          <tr>
                            <td class="text-sm">Admin Roles</td>
                            <td class="text-center">
                              <i data-lucide="x" class="w-4 h-4 text-error"></i>
                            </td>
                            <td class="text-center">
                              <i data-lucide="x" class="w-4 h-4 text-error"></i>
                            </td>
                            <td class="text-center">
                              <i
                                data-lucide="check"
                                class="w-4 h-4 text-success"
                              ></i>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>

                  <!-- Best Practices -->
                  <div>
                    <h4 class="font-semibold mb-3 flex items-center gap-2">
                      <i
                        data-lucide="lightbulb"
                        class="w-4 h-4 text-warning"
                      ></i>
                      Security Best Practices
                    </h4>
                    <div class="space-y-3">
                      <div class="bg-base-200 p-6 rounded-xl">
                        <h5
                          class="font-semibold text-sm mb-2 flex items-center gap-2"
                        >
                          <i
                            data-lucide="shield"
                            class="w-4 h-4 text-success"
                          ></i>
                          Principle of Least Privilege
                        </h5>
                        <p class="text-xs text-neutral">
                          Grant users the minimum access level required for
                          their responsibilities
                        </p>
                      </div>
                      <div class="bg-base-200 p-6 rounded-xl">
                        <h5
                          class="font-semibold text-sm mb-2 flex items-center gap-2"
                        >
                          <i data-lucide="users" class="w-5 h-5 text-black"></i>
                          Regular Access Reviews
                        </h5>
                        <p class="text-xs text-neutral">
                          Periodically review and update admin access based on
                          current needs
                        </p>
                      </div>
                      <div class="bg-base-200 p-6 rounded-xl">
                        <h5
                          class="font-semibold text-sm mb-2 flex items-center gap-2"
                        >
                          <i data-lucide="key" class="w-4 h-4 text-warning"></i>
                          SuperAdmin Protection
                        </h5>
                        <p class="text-xs text-neutral">
                          Limit SuperAdmin roles to 2-3 trusted administrators
                          maximum
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const params = new URLSearchParams(location.search);
      let section = params.get("section") || "manage",
        adminRole = "Guest",
        selectedFields = [],
        availableMasterFieldsCache = [],
        editFormName = "",
        editSelectedFields = [],
        detailsEditFormName = "",
        allFormsData = {};
      function show(e) {
        const t = document.getElementById(e);
        t
          ? t.classList.remove("hidden")
          : console.error("show(): Element not found", e);
      }
      function hide(e) {
        const t = document.getElementById(e);
        t
          ? t.classList.add("hidden")
          : console.error("hide(): Element not found", e);
      }
      function escapeQuotes(e) {
        return String(e).replace(/'/g, "\\'").replace(/"/g, '\\"');
      }
      function escapeAttr(e) {
        return String(e)
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;");
      }
      function fmtDateTime(e) {
        if (!e) return "—";
        try {
          const t = new Date(e);
          return isNaN(t.getTime())
            ? "—"
            : t.toLocaleString(void 0, {
                dateStyle: "short",
                timeStyle: "short",
              });
        } catch {
          return "—";
        }
      }
      function copyToClipboard(text) {
        if (navigator.clipboard && window.isSecureContext) {
          // Use modern Clipboard API
          navigator.clipboard
            .writeText(text)
            .then(() => {
              // Show success feedback
              showToast("Template variable copied!", "success");
            })
            .catch((err) => {
              console.error("Failed to copy text: ", err);
              fallbackCopyToClipboard(text);
            });
        } else {
          // Fallback for older browsers or non-secure contexts
          fallbackCopyToClipboard(text);
        }
      }
      function fallbackCopyToClipboard(text) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed";
        textArea.style.left = "-999999px";
        textArea.style.top = "-999999px";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
          document.execCommand("copy");
          showToast("Template variable copied!", "success");
        } catch (err) {
          console.error("Fallback copy failed: ", err);
          showToast("Failed to copy template variable", "error");
        }
        document.body.removeChild(textArea);
      }
      function showToast(message, type = "info") {
        // Create toast element
        const toast = document.createElement("div");
        toast.className = `alert alert-${type === "success" ? "success" : type === "error" ? "error" : "info"} shadow-lg fixed top-4 right-4 z-50 max-w-sm`;
        toast.innerHTML = `
          <div class="flex items-center gap-2">
            <i data-lucide="${type === "success" ? "check-circle" : type === "error" ? "x-circle" : "info"}" class="w-4 h-4"></i>
            <span>${message}</span>
          </div>
        `;

        document.body.appendChild(toast);

        // Refresh Lucide icons for the new toast
        if (typeof refreshLucideIcons === "function") {
          refreshLucideIcons();
        }

        // Auto remove after 3 seconds
        setTimeout(() => {
          toast.style.opacity = "0";
          toast.style.transform = "translateX(100%)";
          setTimeout(() => {
            if (toast.parentNode) {
              toast.parentNode.removeChild(toast);
            }
          }, 300);
        }, 3000);
      }
      function setActiveTab() {
        document.querySelectorAll("#adminTabs .nav-item").forEach((e) => {
          if (e.dataset.section === section) {
            e.classList.add("btn-primary");
            e.classList.remove("btn-ghost");
          } else {
            e.classList.remove("btn-primary");
            e.classList.add("btn-ghost");
          }
        });

        // Update page title and subtitle based on active section
        const pageTitle = document.getElementById("pageTitle");
        const pageSubtitle = document.getElementById("pageSubtitle");

        const sectionConfig = {
          manage: {
            title: "Manage Forms",
            subtitle: "View and manage placement opportunity forms",
          },
          create: {
            title: "Create New Form",
            subtitle: "Design a new placement opportunity form",
          },
          email: {
            title: "Email Students",
            subtitle: "Send notifications and updates to students",
          },
          students: {
            title: "Student Data",
            subtitle: "Manage student profiles and information",
          },
          rbac: {
            title: "Access Control",
            subtitle: "Manage administrator roles and permissions",
          },
        };

        const config = sectionConfig[section] || {
          title: "Dashboard",
          subtitle: "Welcome to the admin panel",
        };
        if (pageTitle) pageTitle.textContent = config.title;
        if (pageSubtitle) pageSubtitle.textContent = config.subtitle;
      }
      function initAdminPanel() {
        (console.log("initAdminPanel started. Section:", section),
          setActiveTab(),
          google.script.run
            .withSuccessHandler((e) => {
              (console.log("getAdminRole success. Role:", e),
                (adminRole = e),
                (document.getElementById("user-info").textContent =
                  `${adminRole}`));
              const t = "Guest" !== e;
              if (!t)
                return (
                  console.error("Access Denied. User Role:", adminRole),
                  (document.getElementById("loginMessage").textContent =
                    "Access Denied."),
                  void show("loginSection")
                );
              [
                "createPage",
                "managePage",
                "rbacPage",
                "emailPage",
                "studentsPage",
              ].forEach(hide);
              const n = "Editor" === e || "SuperAdmin" === e,
                o = "SuperAdmin" === e,
                l = (e) => {
                  0 === availableMasterFieldsCache.length
                    ? loadAvailableFields(e)
                    : e && e();
                };
              switch ((console.log("Switching section:", section), section)) {
                case "manage":
                  (show("managePage"), refreshForms());
                  break;
                case "create":
                  n
                    ? (show("createPage"),
                      l(() => {
                        renderSelected();
                        initStudentSelector("createStudentSelector", []);
                      }),
                      // Ensure available fields are loaded for the create form
                      setTimeout(() => {
                        if (availableMasterFieldsCache.length === 0) {
                          console.log(
                            "Retrying loadAvailableFields for create page",
                          );
                          loadAvailableFields();
                        }
                      }, 100))
                    : (console.warn("Insufficient role for create:", adminRole),
                      show("loginSection"));
                  break;
                case "email":
                  n
                    ? (show("emailPage"), loadEmailTabData())
                    : (console.warn("Insufficient role for email:", adminRole),
                      show("loginSection"));
                  break;
                case "students":
                  o
                    ? (show("studentsPage"), loadStudentProfileConfig())
                    : (console.warn(
                        "Insufficient role for students:",
                        adminRole,
                      ),
                      show("loginSection"));
                  break;
                case "rbac":
                  (show("rbacPage"), refreshRBACList());
                  break;
                default:
                  (console.log("Defaulting to manage section"),
                    (section = "manage"),
                    setActiveTab(),
                    show("managePage"),
                    refreshForms());
              }
            })
            .withFailureHandler((e) => {
              (console.error("getAdminRole failed:", e),
                (document.getElementById("user-info").textContent =
                  "Auth Error"),
                (document.getElementById("loginMessage").textContent =
                  "Server Auth Error."),
                show("loginSection"));
            })
            .getAdminRole());
      }
      document.querySelectorAll("#adminTabs .nav-item").forEach((e) =>
        e.addEventListener("click", () => {
          (history.pushState(
            null,
            "",
            `?page=admin&section=${e.dataset.section}`,
          ),
            (section = e.dataset.section),
            initAdminPanel());
        }),
      );

      // Navigation helper function
      function navigateToSection(targetSection) {
        section = targetSection;
        history.pushState(null, "", `?page=admin&section=${targetSection}`);
        initAdminPanel();
      }

      // Helper function to update all student selector filter dropdowns
      function refreshStudentSelectorDropdowns() {
        if (availableMasterFieldsCache.length > 0) {
          const filterOptions =
            '<option value="">-- Select Field --</option>' +
            availableMasterFieldsCache
              .map((field) => `<option value="${field}">${field}</option>`)
              .join("");

          document
            .querySelectorAll(".filter-field-select")
            .forEach((select) => {
              select.innerHTML = filterOptions;
            });
        }
      }

      function updateResponsePreview(e) {
        document.getElementById("responsePreview").textContent =
          e.trim().replace(/[^a-zA-Z0-9_]/g, "_") || "Your_Form_Name";
      }
      function loadAvailableFields(e) {
        (console.log("loadAvailableFields called"),
          google.script.run
            .withSuccessHandler((t) => {
              (console.log("getAvailableFields success:", t),
                (availableMasterFieldsCache = t),
                renderAvailableList("availableList", addMasterField),
                renderAvailableList("editAvailableList", editAddMasterField));

              // Update all filter field selects (including student selectors)
              const filterOptions =
                '<option value="">-- Select Field --</option>' +
                availableMasterFieldsCache
                  .map((e) => `<option value="${e}">${e}</option>`)
                  .join("");

              // Update main filter field select if it exists
              const mainFilterSelect =
                document.getElementById("filterFieldSelect");
              if (mainFilterSelect) {
                mainFilterSelect.innerHTML = filterOptions;
              }

              // Update all student selector filter dropdowns
              document
                .querySelectorAll(".filter-field-select")
                .forEach((select) => {
                  select.innerHTML = filterOptions;
                });

              "function" == typeof e && e();
            })
            .withFailureHandler((e) => {
              console.error("getAvailableFields failed:", e);
            })
            .getAvailableFields());
      }
      function renderAvailableList(e, t) {
        const n = document.getElementById(e);
        if (n) {
          if (
            availableMasterFieldsCache &&
            availableMasterFieldsCache.length > 0
          ) {
            n.innerHTML = "";
            (availableMasterFieldsCache || []).forEach((e) => {
              const o = document.createElement("div");
              ((o.className =
                "flex justify-between items-center p-2 bg-base-100 rounded-md shadow-sm"),
                (o.innerHTML = `<span>${e}</span><button onclick="${
                  t.name
                }('${escapeQuotes(
                  e,
                )}')" class="btn btn-xs btn-outline btn-primary">+ Add</button>`),
                n.appendChild(o));
            });
          } else
            n.innerHTML =
              '<p class="text-center text-sm italic p-4">No master fields found.</p>';
        }
      }
      function addMasterField(e) {
        (selectedFields.some((t) => t.label === e) ||
          selectedFields.push({
            key: e,
            label: e,
            source: "master",
            type: "text",
            options: "",
          }),
          renderSelected());
      }
      function addCustomField() {
        const e = document.getElementById("customFieldName"),
          t = e.value.trim(),
          n = document.getElementById("customFieldType").value,
          o = document.getElementById("customFieldOptions").value;
        t && !selectedFields.some((e) => e.label === t)
          ? (selectedFields.push({
              key: t,
              label: t,
              source: "custom",
              type: n,
              options: o,
            }),
            renderSelected(),
            (e.value = ""))
          : alert("Custom field name cannot be empty or duplicate.");
      }
      function renderSelected() {
        const e = document.getElementById("selectedList");
        e &&
          ((e.innerHTML =
            0 === selectedFields.length
              ? '<p class="text-center text-sm italic p-4">No fields selected yet.</p>'
              : ""),
          selectedFields.forEach((t, n) => {
            const o = document.createElement("div");
            ((o.className =
              "flex justify-between items-center p-2 bg-base-100 rounded-md"),
              (o.innerHTML = `<div><span class="font-medium">${
                t.label
              }</span> <div class="badge ${
                "master" === t.source ? "badge-info" : "badge-neutral"
              } badge-sm">${
                t.source
              }</div> <div class="badge badge-outline badge-sm">${
                t.type
              }</div></div><div class="flex gap-1"><button onclick="moveUp(${n})" class="btn btn-xs btn-ghost" ${
                0 === n ? "disabled" : ""
              }><i data-lucide="chevron-up" class="w-3 h-3"></i></button><button onclick="moveDown(${n})" class="btn btn-xs btn-ghost" ${
                n === selectedFields.length - 1 ? "disabled" : ""
              }><i data-lucide="chevron-down" class="w-3 h-3"></i></button><button class="btn btn-xs btn-ghost text-error" onclick="removeAt(${n})"><i data-lucide="x" class="w-3 h-3"></i></button></div>`),
              e.appendChild(o));
          }));
        // Refresh Lucide icons after DOM update
        refreshLucideIcons();
      }
      function moveUp(e) {
        e > 0 &&
          (([selectedFields[e], selectedFields[e - 1]] = [
            selectedFields[e - 1],
            selectedFields[e],
          ]),
          renderSelected());
      }
      function moveDown(e) {
        e < selectedFields.length - 1 &&
          (([selectedFields[e], selectedFields[e + 1]] = [
            selectedFields[e + 1],
            selectedFields[e],
          ]),
          renderSelected());
      }
      function removeAt(e) {
        (selectedFields.splice(e, 1), renderSelected());
      }
      function createForm() {
        const e = document.getElementById("formName").value.trim();
        if (!e) return void alert("Form Name is required.");
        const t = document.getElementById("createMessage");
        if (!t) return;
        ((t.className = "text-info"), (t.innerText = "Creating..."));
        const n = getSelectedRollNos("createStudentSelector"),
          o = {
            formName: e,
            fields: selectedFields,
            accepting:
              "true" === document.getElementById("acceptingSelect").value,
            deadlineIso: document.getElementById("deadlineInput").value
              ? new Date(
                  document.getElementById("deadlineInput").value,
                ).toISOString()
              : "",
            description: document.getElementById("description").value,
            fileLink: document.getElementById("fileLink").value,
            allowedStudents: n,
          };
        (console.log("Creating form with data:", o),
          google.script.run
            .withSuccessHandler((e) => {
              (console.log("createNewForm success:", e),
                (t.className = `text-sm text-center font-semibold text-${
                  e.success ? "success" : "error"
                }`),
                (t.innerText = e.message));
              const n = document.getElementById("createdUrl");
              e.success
                ? ((n.innerHTML = `<b>URL:</b> <a href="${e.url}" target="_blank" class="link link-primary">${e.url}</a>`),
                  show("createdUrl"),
                  (selectedFields = []),
                  renderSelected(),
                  (document.getElementById("formName").value = ""),
                  (document.getElementById("description").value = ""),
                  (document.getElementById("fileLink").value = ""),
                  initStudentSelector("createStudentSelector", []))
                : hide("createdUrl");
            })
            .withFailureHandler((e) => {
              (console.error("createNewForm failed:", e),
                (t.className = "text-error font-semibold"),
                (t.innerText = "Error: " + e.message));
            })
            .createNewForm(o));
      }
      function refreshForms() {
        console.log("refreshForms called");
        const formsTable = document.getElementById("formsTbody");

        // Show loading state in table
        if (formsTable) {
          formsTable.innerHTML =
            '<tr><td colspan="5" class="text-center py-8"><div class="flex items-center justify-center gap-3"><span class="loading loading-dots loading-lg text-primary"></span><span class="text-neutral">Loading forms...</span></div></td></tr>';
        }

        allFormsData = {};

        google.script.run
          .withSuccessHandler((response) => {
            console.log("getAllForms success:", response);

            if (!response.success || response.forms.length === 0) {
              if (formsTable) {
                formsTable.innerHTML = `
                  <tr>
                    <td colspan="5" class="text-center py-16">
                      <div class="flex flex-col items-center space-y-6">
                        <div class="p-6 rounded-full bg-accent/10">
                          <i data-lucide="folder-plus" class="w-16 h-16 text-neutral"></i>
                        </div>
                        <div class="space-y-3">
                          <h3 class="text-xl font-bold">No Forms Created Yet</h3>
                          <p class="text-neutral max-w-md mx-auto">Create your first placement opportunity form to get started</p>
                        </div>
                        <div class="flex gap-3">
                          <button onclick="navigateToSection('create')" class="btn btn-primary">
                            <i data-lucide="plus-circle" class="w-4 h-4"></i>
                            Create First Form
                          </button>
                          <button onclick="refreshForms()" class="btn btn-outline">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                            Refresh
                          </button>
                        </div>
                      </div>
                    </td>
                  </tr>
                `;
              }
              refreshLucideIcons();
              return;
            }

            // Sort forms by deadline (active first, then by recent deadline)
            response.forms.sort((a, b) => {
              // Priority: Active forms first, then by deadline
              if (a.accepting && !b.accepting) return -1;
              if (!a.accepting && b.accepting) return 1;
              return (b.deadlineMs || 0) - (a.deadlineMs || 0);
            });

            // Calculate form statistics
            const stats = {
              total: response.forms.length,
              active: response.forms.filter((f) => f.accepting).length,
              expired: response.forms.filter(
                (f) => f.deadlineMs && f.deadlineMs < Date.now(),
              ).length,
              totalResponses: response.forms.reduce(
                (sum, f) => sum + (f.responses || 0),
                0,
              ),
            };

            // Update stats display
            const statsDisplay = document.getElementById("formsStatsDisplay");
            if (statsDisplay) {
              statsDisplay.innerHTML = `
                <div class="flex items-center gap-4 text-sm">
                  <div class="flex items-center gap-1">
                    <div class="w-2 h-2 rounded-full bg-success"></div>
                    <span>${stats.active} Active</span>
                  </div>
                  <div class="flex items-center gap-1">
                    <div class="w-2 h-2 rounded-full bg-neutral"></div>
                    <span>${stats.total - stats.active} Closed</span>
                  </div>
                  <div class="flex items-center gap-1">
                    <i data-lucide="users" class="w-3 h-3"></i>
                    <span>${stats.totalResponses} Total Responses</span>
                  </div>
                </div>
              `;
            }

            // Generate table rows
            if (formsTable) {
              formsTable.innerHTML = response.forms
                .map((form) => {
                  allFormsData[form.formName] = form;

                  // Determine status badge
                  let statusBadge = "";
                  let statusColor = "";
                  let statusIcon = "";
                  if (form.accepting) {
                    if (form.deadlineMs && form.deadlineMs < Date.now()) {
                      statusBadge = "Expired";
                      statusColor = "badge-warning";
                      statusIcon = "clock";
                    } else {
                      statusBadge = "Active";
                      statusColor = "badge-success";
                      statusIcon = "check-circle";
                    }
                  } else {
                    statusBadge = "Closed";
                    statusColor = "badge-neutral";
                    statusIcon = "x-circle";
                  }

                  return `
                    <tr class="hover:bg-base-200 transition-colors">
                      <td>
                        <div class="font-bold truncate max-w-xs" title="${form.formName}">${form.formName}</div>
                        <div class="text-sm text-neutral truncate">${form.description ? form.description.substring(0, 50) + "..." : ""}</div>
                      </td>
                      <td class="text-center">
                        ${
                          adminRole === "Editor" || adminRole === "SuperAdmin"
                            ? `
                          <div class="flex flex-col items-center gap-2">
                            <input type="checkbox" class="toggle toggle-sm toggle-success" 
                                   ${form.accepting ? "checked" : ""} 
                                   onchange="toggleFormAccepting('${escapeQuotes(form.formName)}', this.checked)"
                                   ${form.deadlineMs && form.deadlineMs < Date.now() ? 'disabled title="Form has expired"' : ""} />
                            <div class="text-xs ${form.accepting ? (form.deadlineMs && form.deadlineMs < Date.now() ? "text-warning" : "text-success") : "text-neutral"}">
                              ${form.accepting ? (form.deadlineMs && form.deadlineMs < Date.now() ? "Expired" : "Active") : "Closed"}
                            </div>
                          </div>
                        `
                            : `
                          <div class="badge ${statusColor} gap-1">
                            <i data-lucide="${statusIcon}" class="w-3 h-3"></i>
                            ${statusBadge}
                          </div>
                        `
                        }
                      </td>
                      <td class="hidden sm:table-cell">${form.deadlineMs ? fmtDateTime(form.deadlineMs) : "—"}</td>
                      <td class="text-center font-mono font-bold">${form.responses}</td>
                      <td class="text-right">
                        <div class="flex gap-1 justify-end">
                          <a href="${form.url}" target="_blank" class="btn btn-xs btn-ghost">
                            <i data-lucide="external-link" class="w-3 h-3"></i>
                          </a>
                          ${
                            adminRole === "Editor" || adminRole === "SuperAdmin"
                              ? `
                            <button class="btn btn-xs btn-ghost" onclick="openPropertiesModal('${escapeQuotes(form.formName)}')">
                              <i data-lucide="settings" class="w-3 h-3"></i>
                            </button>
                            <button class="btn btn-xs btn-ghost" onclick="openEditPanel('${escapeQuotes(form.formName)}')">
                              <i data-lucide="edit" class="w-3 h-3"></i>
                            </button>
                            <button class="btn btn-xs btn-ghost" onclick="duplicateFormUI('${escapeQuotes(form.formName)}')">
                              <i data-lucide="copy" class="w-3 h-3"></i>
                            </button>
                          `
                              : ""
                          }
                          ${
                            adminRole === "SuperAdmin"
                              ? `
                            <button class="btn btn-xs btn-ghost hover:btn-error" onclick="deleteFormUI('${escapeQuotes(form.formName)}')">
                              <i data-lucide="trash-2" class="w-3 h-3"></i>
                            </button>
                          `
                              : ""
                          }
                        </div>
                      </td>
                    </tr>
                  `;
                })
                .join("");
            }

            refreshLucideIcons();
          })
          .withFailureHandler((error) => {
            console.error("getAllForms failed:", error);
            if (formsTable) {
              formsTable.innerHTML = `
                <tr>
                  <td colspan="5" class="text-center py-16">
                    <div class="flex flex-col items-center space-y-6">
                      <div class="p-6 rounded-full bg-error/10">
                        <i data-lucide="alert-triangle" class="w-16 h-16 text-error"></i>
                      </div>
                      <div class="space-y-3">
                        <h3 class="text-xl font-bold text-error">Error Loading Forms</h3>
                        <p class="text-neutral max-w-md mx-auto">${error.message}</p>
                      </div>
                      <div class="flex gap-3">
                        <button onclick="refreshForms()" class="btn btn-primary">
                          <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                          Try Again
                        </button>
                        <button onclick="location.reload()" class="btn btn-outline">
                          <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                          Reload Page
                        </button>
                      </div>
                    </div>
                  </td>
                </tr>
              `;
            }
            refreshLucideIcons();
          })
          .getAllForms();
      }

      function toggleFormAccepting(e, t) {
        (console.log(`toggleFormAccepting: ${e}, ${t}`),
          setManageMsg("info", "Updating..."),
          google.script.run
            .withSuccessHandler((response) => {
              (console.log("setFormAccepting success:", response),
                setManageMsg(
                  response.success ? "success" : "error",
                  response.message,
                ));
              if (response.success) {
                // Refresh the forms table to show updated status
                setTimeout(() => refreshForms(), 1000);
              }
            })
            .withFailureHandler((error) => {
              (console.error("setFormAccepting failed:", error),
                setManageMsg("error", error.message));
              // Refresh forms to revert toggle state if there was an error
              setTimeout(() => refreshForms(), 1000);
            })
            .setFormAccepting(e, t));
      }

      function duplicateFormUI(formName) {
        // 1. Suggest a default name
        const suggestedName = "Copy of " + formName;

        // 2. Use prompt() to ask the user for a new name
        const newName = prompt(`Enter a new name for the duplicated form:`, suggestedName);

        // 3. Check if the user clicked "Cancel"
        if (newName === null) {
          return; // User cancelled, do nothing
        }

        // 4. Check if the user entered an empty name
        const trimmedName = newName.trim();
        if (trimmedName === "") {
          setManageMsg("error", "New name cannot be empty.");
          return;
        }

        // 5. Proceed with the server call, passing BOTH names
        console.log(`duplicateFormUI: Original='${formName}', New='${trimmedName}'`);
        setManageMsg("info", "Duplicating...");
        google.script.run
          .withSuccessHandler((e) => {
            console.log("duplicateForm success:", e);
            setManageMsg(e.success ? "success" : "error", e.message);
            e.success && refreshForms(); // Refresh the list if successful
          })
          .withFailureHandler((e) => {
            console.error("duplicateForm failed:", e);
            setManageMsg("error", e.message);
          })
          .duplicateForm(formName, trimmedName); // <-- Pass original name and new name
      }
      function setManageMsg(e, t) {
        const n = document.getElementById("manageMessage");
        n &&
          ((n.className = `text-center font-semibold text-sm text-${e}`),
          (n.innerText = t),
          setTimeout(() => (n.innerText = ""), 4e3));
      }
      function deleteFormUI(e) {
        confirm(
          `Delete form "${e}"? This will also delete its response sheet. This CANNOT be undone.`,
        ) &&
          (console.log(`deleteFormUI: ${e}`),
          setManageMsg("info", "Deleting..."),
          google.script.run
            .withSuccessHandler((e) => {
              (console.log("deleteForm success:", e),
                setManageMsg(e.success ? "success" : "error", e.message),
                e.success && refreshForms());
            })
            .withFailureHandler((e) => {
              (console.error("deleteForm failed:", e),
                setManageMsg("error", e.message));
            })
            .deleteForm(e));
      }
      function openEditPanel(e) {
        (console.log(`openEditPanel: ${e}`),
          (editFormName = e),
          (document.getElementById("editFormNameLabel").textContent = e),
          (document.getElementById("saveFieldsBtn").disabled =
            "Editor" !== adminRole && "SuperAdmin" !== adminRole),
          // Load available fields if not cached
          availableMasterFieldsCache.length === 0 && loadAvailableFields(),
          google.script.run
            .withSuccessHandler((t) => {
              (console.log("getFormConfig for edit success:", t),
                (editSelectedFields = t.fields.map((e) => ({
                  ...e,
                  id: e.label || e.key,
                }))),
                renderEditSelected(),
                renderAvailableList("editAvailableList", editAddMasterField),
                document.getElementById("editFieldsModal").showModal(),
                refreshLucideIcons());
            })
            .withFailureHandler((e) => {
              (console.error("getFormConfig for edit failed:", e),
                alert("Error loading form fields: " + e.message));
            })
            .getFormConfig(e));
      }
      function closeEditPanel() {
        document.getElementById("editFieldsModal").close();
      }
      function renderEditSelected() {
        const e = document.getElementById("editSelectedList");
        ((e.innerHTML = ""),
          editSelectedFields.forEach((t, n) => {
            const o = document.createElement("div");
            ((o.className = "flex items-center gap-2 p-1 bg-base-200 rounded"),
              (o.innerHTML = `<input type="text" value="${escapeAttr(
                t.label,
              )}" oninput="editRename(${n},this.value)" class="input input-bordered input-sm grow"/><div class="badge badge-sm ${
                "master" === t.source ? "badge-info" : "badge-neutral"
              }">${
                "master" === t.source ? "master" : t.type
              }</div><button onclick="editMoveUp(${n})" class="btn btn-xs btn-ghost" ${
                0 === n ? "disabled" : ""
              }><i data-lucide="chevron-up" class="w-3 h-3"></i></button><button onclick="editMoveDown(${n})" class="btn btn-xs btn-ghost" ${
                n === editSelectedFields.length - 1 ? "disabled" : ""
              }><i data-lucide="chevron-down" class="w-3 h-3"></i></button><button class="btn btn-xs btn-ghost text-error" onclick="editRemoveAt(${n})"><i data-lucide="x" class="w-3 h-3"></i></button>`),
              e.appendChild(o));
          }));
        // Refresh Lucide icons after DOM update
        refreshLucideIcons();
      }
      function editMoveUp(e) {
        e > 0 &&
          (([editSelectedFields[e], editSelectedFields[e - 1]] = [
            editSelectedFields[e - 1],
            editSelectedFields[e],
          ]),
          renderEditSelected());
      }
      function editMoveDown(e) {
        e < editSelectedFields.length - 1 &&
          (([editSelectedFields[e], editSelectedFields[e + 1]] = [
            editSelectedFields[e + 1],
            editSelectedFields[e],
          ]),
          renderEditSelected());
      }
      function editAddMasterField(e) {
        (selectedFields.some((t) => t.label === e) ||
          editSelectedFields.push({
            id: e,
            label: e,
            key: e,
            source: "master",
            type: "text",
            options: "",
          }),
          renderEditSelected());
      }
      function editAddCustomField() {
        const e = document.getElementById("editCustomFieldName"),
          t = e.value.trim(),
          n = document.getElementById("editCustomFieldType").value,
          o = document.getElementById("editCustomFieldOptions").value;
        t && !editSelectedFields.some((e) => e.label === t)
          ? (editSelectedFields.push({
              id: t,
              label: t,
              key: t,
              source: "custom",
              type: n,
              options: o,
            }),
            renderEditSelected(),
            (e.value = ""))
          : alert("Custom field name cannot be empty or duplicate.");
      }
      function editRename(e, t) {
        ((editSelectedFields[e].label = t),
          "custom" === editSelectedFields[e].source &&
            (editSelectedFields[e].key = t));
      }
      function editRemoveAt(e) {
        (editSelectedFields.splice(e, 1), renderEditSelected());
      }
      function saveFieldEdits() {
        const e = document.getElementById("editSaveMessage");
        ((e.innerText = "Saving..."),
          console.log(
            "Saving field edits for:",
            editFormName,
            "Fields:",
            editSelectedFields,
          ),
          google.script.run
            .withSuccessHandler((t) => {
              (console.log("updateFormFields success:", t),
                (e.className = `text-sm ${
                  t.success ? "text-success" : "text-error"
                }`),
                (e.innerText = t.message),
                t.success &&
                  (refreshForms(), setTimeout(closeEditPanel, 1500)));
            })
            .withFailureHandler((t) => {
              (console.error("updateFormFields failed:", t),
                (e.className = "text-error"),
                (e.innerText = "Error: " + t.message));
            })
            .updateFormFields(editFormName, editSelectedFields));
      }
      function openPropertiesModal(formName) {
        console.log(`openPropertiesModal: ${formName}`);
        const form = allFormsData[formName];
        if (!form)
          return (
            console.error("Could not find form data in cache for:", formName),
            alert("Error: Could not find form data.")
          );
        ((document.getElementById("propsFormName").textContent = form.formName),
          (document.getElementById("propsFormNameHidden").value =
            form.formName),
          (document.getElementById("propsDescription").value =
            form.description || ""),
          (document.getElementById("propsFileLink").value =
            form.fileLink || ""));
        if (form.deadlineMs) {
          const e = new Date(form.deadlineMs),
            t = e.getFullYear(),
            n = String(e.getMonth() + 1).padStart(2, "0"),
            o = String(e.getDate()).padStart(2, "0"),
            s = String(e.getHours()).padStart(2, "0"),
            a = String(e.getMinutes()).padStart(2, "0");
          document.getElementById("propsDeadlineInput").value =
            `${t}-${n}-${o}T${s}:${a}`;
        } else document.getElementById("propsDeadlineInput").value = "";
        const rollNoArray = form.allowedStudents
          ? form.allowedStudents.split(",")
          : [];

        // Ensure available fields are loaded before initializing student selector
        if (availableMasterFieldsCache.length === 0) {
          loadAvailableFields(() => {
            initStudentSelector("propsStudentSelector", rollNoArray);
            document.getElementById("propsSaveMessage").innerText = "";
            editPropertiesModal.showModal();
          });
        } else {
          initStudentSelector("propsStudentSelector", rollNoArray);
          document.getElementById("propsSaveMessage").innerText = "";
          editPropertiesModal.showModal();
        }
      }
      function saveProperties() {
        const e = document.getElementById("propsFormNameHidden").value,
          t = document.getElementById("propsDeadlineInput").value,
          n = {
            description: document.getElementById("propsDescription").value,
            fileLink: document.getElementById("propsFileLink").value,
            allowedStudents: getSelectedRollNos("propsStudentSelector"),
            deadlineIso: t ? new Date(t).toISOString() : "",
          },
          o = document.getElementById("propsSaveMessage");
        (console.log("Saving properties for:", e, "Data:", n),
          (o.className = "text-info"),
          (o.innerText = "Saving..."),
          (document.getElementById("savePropsBtn").disabled = !0),
          google.script.run
            .withSuccessHandler((e) => {
              (console.log("updateFormProperties success:", e),
                (o.className = `text-sm font-semibold ${
                  e.success ? "text-success" : "text-error"
                }`),
                (o.innerText = e.message),
                (document.getElementById("savePropsBtn").disabled = !1),
                e.success &&
                  (refreshForms(),
                  setTimeout(() => editPropertiesModal.close(), 1500)));
            })
            .withFailureHandler((e) => {
              (console.error("updateFormProperties failed:", e),
                (o.className = "text-error"),
                (o.innerText = "Error: " + e.message),
                (document.getElementById("savePropsBtn").disabled = !1));
            })
            .updateFormProperties(e, n));
      }
      function getStudentSelectorHtml(idPrefix) {
        return `
          <div class="student-selector bg-base-200 rounded-2xl p-6 border border-base-300/50" id="${idPrefix}">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <!-- Students List (Left Column) -->
              <div class="space-y-4">
                <div class="flex items-center justify-between">
                  <h4 class="font-semibold text-base flex items-center gap-2">
                    <i data-lucide="users" class="w-4 h-4 text-primary"></i>
                    Student List
                  </h4>
                  <div class="student-list-count text-sm text-neutral">Loading...</div>
                </div>
                
                <div class="flex items-center justify-between py-2 px-3 bg-base-100 rounded-lg border border-base-300">
                  <span class="text-sm font-medium">Selection Control</span>
                  <label class="label cursor-pointer gap-2">
                    <span class="label-text text-sm">Select All Visible</span>
                    <input type="checkbox" class="checkbox checkbox-primary checkbox-sm select-all-checkbox"/>
                  </label>
                </div>
                
                <div class="h-64 overflow-y-auto bg-base-100 rounded-xl border border-base-300 p-4 space-y-2 student-list-container">
                  <div class="flex flex-col items-center justify-center py-8 text-center">
                    <div class="loading loading-dots loading-md text-primary mb-3"></div>
                    <p class="text-neutral font-medium">Loading students...</p>
                  </div>
                </div>
              </div>
              
              <!-- Filter Controls (Right Column) -->
              <div class="space-y-4">
                <h4 class="font-semibold text-base flex items-center gap-2">
                  <i data-lucide="filter" class="w-4 h-4 text-secondary"></i>
                  Filter Options
                </h4>
                
                <div class="space-y-4 bg-base-100 rounded-xl p-4 border border-base-300">
                  <!-- Filter Field -->
                  <div class="form-control w-full">
                    <label class="label">
                      <span class="label-text font-medium">Filter by Field</span>
                    </label>
                    <select class="select select-bordered w-full filter-field-select" id="${idPrefix}_filterField">
                      <option value="">-- Select Field --</option>
                    </select>
                  </div>
                  
                  <!-- Filter Value -->
                  <div class="form-control w-full">
                    <label class="label">
                      <span class="label-text font-medium">Filter Value</span>
                    </label>
                    <input 
                      type="text" 
                      placeholder="e.g., CSE, >=8.5, 2021" 
                      class="input input-bordered w-full filter-value-input" 
                      id="${idPrefix}_filterValue"
                    />
                    <div class="label">
                      <span class="label-text-alt text-neutral">Use operators: >=, <=, *, or exact values</span>
                    </div>
                  </div>
                  
                  <!-- Action Buttons -->
                  <div class="flex flex-col gap-2 mt-6">
                    <button type="button" class="btn btn-primary w-full filter-btn">
                      <i data-lucide="search" class="w-4 h-4"></i>
                      Apply Filter
                    </button>
                    <button type="button" class="btn btn-ghost w-full clear-filter-btn">
                      <i data-lucide="x" class="w-4 h-4"></i>
                      Clear Filter
                    </button>
                  </div>
                </div>
                
                <!-- Filter Tips -->
                <div class="bg-info/10 rounded-xl p-4 border border-info/20">
                  <div class="flex items-start gap-3">
                    <i data-lucide="lightbulb" class="w-5 h-5 text-info mt-0.5"></i>
                    <div>
                      <h5 class="font-medium text-sm text-info mb-2">Filter Examples</h5>
                      <ul class="text-xs space-y-1 text-neutral">
                        <li><strong>CGPA >=8.5:</strong> Students with CGPA 8.5 or higher</li>
                        <li><strong>Department CSE:</strong> Only CSE students</li>
                        <li><strong>Email *gmail.com:</strong> Gmail addresses only</li>
                        <li><strong>Year 2021:</strong> Students from 2021 batch</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }
      function initStudentSelector(containerId, preselectedRollNos) {
        console.log(`initStudentSelector: ${containerId}`, preselectedRollNos);
        const container = document.getElementById(containerId);
        if (!container)
          return console.error("Container not found:", containerId);
        container.innerHTML = getStudentSelectorHtml(containerId);

        // Refresh Lucide icons after inserting HTML
        lucide.createIcons();

        const filterFieldSelect = container.querySelector(
          ".filter-field-select",
        );
        ((filterFieldSelect.innerHTML =
          '<option value="">-- Select Field --</option>' +
          availableMasterFieldsCache
            .map((f) => `<option value="${f}">${f}</option>`)
            .join("")),
          applyStudentSelectorFilter(containerId, preselectedRollNos),
          (container.querySelector(".filter-btn").onclick = () =>
            applyStudentSelectorFilter(containerId, [], true)),
          (container.querySelector(".clear-filter-btn").onclick = () => {
            // Save current selections before clearing filter
            saveSelectionState(containerId);
            ((container.querySelector(".filter-field-select").value = ""),
              (container.querySelector(".filter-value-input").value = ""),
              applyStudentSelectorFilter(
                containerId,
                getStoredSelections(containerId),
                false,
              ));
          }),
          (container.querySelector(".select-all-checkbox").onchange = (e) => {
            handleSelectAll(containerId, e.target);
          }));
      }
      function applyStudentSelectorFilter(
        containerId,
        preselectedRollNos,
        keepChecked = !1,
      ) {
        console.log(
          `applyStudentSelectorFilter: ${containerId}`,
          preselectedRollNos,
          "Keep checked:",
          keepChecked,
        );
        const container = document.getElementById(containerId),
          listContainer = container.querySelector(".student-list-container"),
          countLabel = container.querySelector(".student-list-count"),
          filterField = container.querySelector(".filter-field-select").value,
          filterValue = container.querySelector(".filter-value-input").value,
          filters = {};
        filterField && filterValue && (filters[filterField] = filterValue);

        // Save current selections before filtering if keepChecked is true
        if (keepChecked) {
          saveSelectionState(containerId);
        }

        let checkedStudents = keepChecked
          ? getStoredSelections(containerId)
          : preselectedRollNos || [];

        // Ensure checkedStudents is always an array
        if (typeof checkedStudents === "string") {
          checkedStudents = checkedStudents.split(",").filter((s) => s.trim());
        }

        // Reset select all checkbox when filtering
        const selectAllCheckbox = container.querySelector(
          ".select-all-checkbox",
        );
        if (selectAllCheckbox) {
          selectAllCheckbox.checked = false;
          selectAllCheckbox.indeterminate = false;
        }
        ((listContainer.innerHTML =
          '<div class="flex flex-col items-center justify-center py-8 text-center"><div class="loading loading-dots loading-md text-primary mb-3"></div><p class="text-neutral font-medium">Filtering students...</p></div>'),
          google.script.run
            .withSuccessHandler((students) => {
              (console.log(
                `getStudentList success for selector ${containerId}:`,
                students,
              ),
                (listContainer.innerHTML = ""));
              if (students.error)
                return (
                  (listContainer.innerHTML = `<p class="text-error p-4">${students.error}</p>`),
                  void (countLabel.textContent = "Error")
                );
              (students.forEach((student) => {
                const label = document.createElement("label");
                label.className =
                  "flex items-center justify-between p-3 bg-base-200 hover:bg-base-300 rounded-lg transition-colors cursor-pointer border border-base-300/50";
                const isChecked = checkedStudents.includes(student.rollNo)
                  ? "checked"
                  : "";

                label.innerHTML = `
                  <div class="flex items-center gap-3">
                    <input type="checkbox" value="${student.rollNo}" class="checkbox checkbox-primary checkbox-sm student-checkbox" ${isChecked}/>
                    <div class="flex flex-col">
                      <span class="font-medium text-sm">${student.name}</span>
                      <span class="text-xs text-neutral">${student.rollNo}</span>
                    </div>
                  </div>
                `;
                listContainer.appendChild(label);

                // Add event listener for bidirectional sync
                const checkbox = label.querySelector(".student-checkbox");
                checkbox.addEventListener("change", () =>
                  updateSelectAllState(containerId),
                );
              }),
                (countLabel.textContent = `${students.length} students found`),
                // Update select all state after loading
                updateSelectAllState(containerId));
            })
            .withFailureHandler((e) => {
              (console.error(
                `getStudentList failed for selector ${containerId}:`,
                e,
              ),
                (listContainer.innerHTML = `<p class="text-error p-4">Error: ${e.message}</p>`),
                (countLabel.textContent = "Error"));
            })
            .getStudentList(filters));
      }
      function getSelectedRollNos(containerId) {
        const container = document.getElementById(containerId);
        if (!container) return "";

        const checkboxes = container.querySelectorAll(
          ".student-checkbox:checked",
        );
        return Array.from(checkboxes)
          .map((cb) => cb.value)
          .filter((value) => value && value.trim() !== "")
          .join(",");
      }

      // Store and retrieve selection state across filters
      const selectionState = new Map();

      function saveSelectionState(containerId) {
        const selected = getSelectedRollNos(containerId);
        if (selected) {
          selectionState.set(containerId, selected.split(","));
        }
      }

      function getStoredSelections(containerId) {
        return selectionState.get(containerId) || [];
      }
      function loadEmailTabData() {
        (google.script.run
          .withSuccessHandler((e) => {
            const t = document.getElementById("emailFormSelect");
            // FIX: Add "No Form" option
            if (t) {
              t.innerHTML =
                '<option value="">-- No Form (General Email) --</option>';
              e.success &&
                e.forms.forEach((e) => {
                  const n = document.createElement("option");
                  ((n.value = e.formName),
                    (n.textContent = e.formName),
                    t.appendChild(n));
                });
            }
          })
          .withFailureHandler((error) => {
            console.error("getAllForms failed:", error);
            const t = document.getElementById("emailFormSelect");
            if (t) {
              t.innerHTML = '<option value="">Error loading forms</option>';
            }
          })
          .getAllForms(),
          applyStudentFilter());
      }
      function applyStudentFilter() {
        const e = document.getElementById("filterFieldSelect").value,
          t = document.getElementById("filterValueInput").value,
          n = {};
        e && t && (n[e] = t);

        // Save current email selections
        const currentSelections = Array.from(
          document.querySelectorAll("#studentList .student-checkbox:checked"),
        ).map((cb) => cb.value);
        selectionState.set("emailPage", currentSelections);

        const o = document.getElementById("studentList"),
          l = document.getElementById("studentListCount");
        // Reset select all checkbox when filtering
        const selectAllCheckbox = document.getElementById("selectAllStudents");
        if (selectAllCheckbox) {
          selectAllCheckbox.checked = false;
          selectAllCheckbox.indeterminate = false;
        }
        (o &&
          (o.innerHTML =
            '<div class="loading-state"><span class="loading loading-dots loading-md"></span></div>'),
          google.script.run
            .withSuccessHandler((e) => {
              if (!o || !l) return;
              if (((o.innerHTML = ""), e.error))
                return (
                  (l.textContent = "Error"),
                  void (o.innerHTML = `<p class="text-error p-4">${e.error}</p>`)
                );
              ((l.textContent = `${e.length} students found`),
                e.forEach((e) => {
                  const storedSelections =
                    selectionState.get("emailPage") || [];
                  const isSelected = storedSelections.includes(e.email);
                  const n = document.createElement("div");
                  ((n.className = "form-control"),
                    (n.innerHTML = `<label class="label cursor-pointer"><span class="label-text">${e.name} (${e.rollNo})</span><input type="checkbox" value="${e.email}" class="checkbox student-checkbox" ${isSelected ? "checked" : ""}/></label>`),
                    o.appendChild(n));

                  // Add event listener for bidirectional sync
                  const checkbox = n.querySelector(".student-checkbox");
                  checkbox.addEventListener("change", () =>
                    updateSelectAllState("emailPage"),
                  );
                }),
                // Update select all state after loading
                updateSelectAllState("emailPage"));
            })
            .withFailureHandler((error) => {
              console.error("getStudentList failed:", error);
              if (o && l) {
                l.textContent = "Error loading students";
                o.innerHTML = `<p class="text-error p-4">Failed to load students: ${error.message || error}</p>`;
              }
            })
            .getStudentList(n));
      }
      function clearStudentFilter() {
        ((document.getElementById("filterFieldSelect").value = ""),
          (document.getElementById("filterValueInput").value = ""),
          applyStudentFilter());
      }
      // Improved select all functionality with proper scope handling
      function toggleSelectAll(checked) {
        const studentList = document.getElementById("studentList");
        if (!studentList) return;

        studentList
          .querySelectorAll(".student-checkbox")
          .forEach((checkbox) => (checkbox.checked = checked));
      }

      // Generic function to handle select all for any container
      function handleSelectAll(containerId, selectAllCheckbox) {
        let container;
        if (containerId === "emailPage") {
          container = document.getElementById("studentList");
        } else {
          container = document.getElementById(containerId);
        }

        if (!container) return;

        const individualCheckboxes =
          container.querySelectorAll(".student-checkbox");
        individualCheckboxes.forEach((checkbox) => {
          checkbox.checked = selectAllCheckbox.checked;
        });

        // Update the indeterminate state
        selectAllCheckbox.indeterminate = false;
      }

      // Function to update select all checkbox based on individual selections
      function updateSelectAllState(containerId) {
        let container, selectAllCheckbox;

        if (containerId === "emailPage") {
          container = document.getElementById("studentList");
          selectAllCheckbox = document.getElementById("selectAllStudents");
        } else {
          container = document.getElementById(containerId);
          selectAllCheckbox = container
            ? container.querySelector(".select-all-checkbox")
            : null;
        }

        if (!container || !selectAllCheckbox) return;

        const individualCheckboxes =
          container.querySelectorAll(".student-checkbox");
        const checkedCount = container.querySelectorAll(
          ".student-checkbox:checked",
        ).length;
        const totalCount = individualCheckboxes.length;

        if (totalCount === 0) {
          selectAllCheckbox.checked = false;
          selectAllCheckbox.indeterminate = false;
        } else if (checkedCount === totalCount) {
          selectAllCheckbox.checked = true;
          selectAllCheckbox.indeterminate = false;
        } else if (checkedCount === 0) {
          selectAllCheckbox.checked = false;
          selectAllCheckbox.indeterminate = false;
        } else {
          selectAllCheckbox.checked = false;
          selectAllCheckbox.indeterminate = true;
        }
      }
      // 📤 Send regular emails to students
      function sendEmails() {
        const formSelect = document.getElementById("emailFormSelect");
        const subjectEl = document.getElementById("emailSubject");
        const bodyEl = document.getElementById("emailBody");
        const messageEl = document.getElementById("emailMessage");

        if (!formSelect || !subjectEl || !bodyEl || !messageEl) {
          console.error("Missing one or more elements in sendEmails()");
          return;
        }

        const formType = formSelect.value;
        const subject = subjectEl.value.trim();
        const body = bodyEl.value.trim();

        const studentEmails = Array.from(
          document.querySelectorAll("#studentList .student-checkbox:checked")
        ).map((e) => e.value);

        const options = {
          useReplyTo: document.getElementById("emailUseReplyTo")?.checked || false,
          senderName: document.getElementById("emailSenderName")?.value.trim() || "",
        };

        if (!subject || !body || studentEmails.length === 0) {
          alert("⚠️ Please fill in subject & body and select at least one student.");
          return;
        }

        messageEl.className = "text-info text-center font-medium";
        messageEl.innerText = "Sending emails... Please wait.";

        google.script.run
          .withSuccessHandler((response) => {
            messageEl.className = `text-sm font-semibold text-center ${
              response.success ? "text-success" : "text-error"
            }`;
            messageEl.innerText = response.message || "Done.";
            setTimeout(() => (messageEl.innerText = ""), 5000);
          })
          .withFailureHandler((err) => {
            messageEl.className = "text-error text-center font-semibold";
            messageEl.innerText = `Error: ${err.message || err}`;
          })
          .sendEmailToStudents(formType, studentEmails, subject, body, options);
      }

      // 🔍 Find Gmail messages to forward
      function findEmail() {
        const findBtn = document.getElementById("findEmailBtn");
        const loader = findBtn?.querySelector(".loading");
        const searchTermEl = document.getElementById("emailSearchTerm");
        const resultsEl = document.getElementById("emailSearchResults");
        const forwardMsgEl = document.getElementById("forwardMessage");

        if (!findBtn || !searchTermEl || !resultsEl || !forwardMsgEl) {
          console.error("Missing one or more elements in findEmail()");
          return;
        }

        const searchTerm = searchTermEl.value.trim();
        if (!searchTerm) {
          resultsEl.innerHTML =
            '<p class="text-error text-center py-2">Please enter a search term.</p>';
          return;
        }

        findBtn.disabled = true;
        if (loader) loader.classList.remove("hidden");
        forwardMsgEl.innerText = "";
        resultsEl.innerHTML =
          '<div class="loading-state flex justify-center py-4"><span class="loading loading-dots loading-md"></span></div>';

        google.script.run
          .withSuccessHandler((response) => {
            findBtn.disabled = false;
            if (loader) loader.classList.add("hidden");

            if (response.error) {
              resultsEl.innerHTML = `<p class="text-error text-center">${response.error}</p>`;
              return;
            }

            const messages = response.messages || [];
            resultsEl.innerHTML = "";

            if (messages.length === 0) {
              resultsEl.innerHTML =
                '<p class="text-center italic text-neutral py-4">No emails found.</p>';
              return;
            }

            messages.forEach((msg) => {
              const escapedSubject = escapeQuotes(msg.subject || "(No Subject)");
              const escapedFrom = escapeAttr(msg.from || "Unknown Sender");
              const formattedDate = fmtDateTime(msg.date);

              resultsEl.innerHTML += `
                <div class="p-2 border rounded-md hover:bg-base-200 transition-colors">
                  <div class="font-bold">${escapedSubject}</div>
                  <div class="text-sm text-neutral">From: ${escapedFrom}</div>
                  <div class="text-xs text-neutral">Date: ${formattedDate}</div>
                  <button 
                    class="btn btn-sm btn-outline mt-2"
                    onclick="selectEmailToForward('${msg.id}', '${escapedSubject}')"
                  >
                    Select to Forward
                  </button>
                </div>`;
            });
          })
          .withFailureHandler((err) => {
            findBtn.disabled = false;
            if (loader) loader.classList.add("hidden");
            resultsEl.innerHTML = `<p class="text-error text-center">Error: ${
              err.message || err
            }</p>`;
          })
          .findAdminEmail(searchTerm);
      }

      // 📩 Select email to forward
      function selectEmailToForward(id, subject) {
        const msgIdEl = document.getElementById("forwardMessageId");
        const subjectEl = document.getElementById("forwardSubject");
        const bodyEl = document.getElementById("forwardMessage"); // Correct ID

        if (!msgIdEl || !subjectEl || !bodyEl) {
          console.error("Forward form elements missing in selectEmailToForward()");
          return;
        }

        msgIdEl.value = id;
        subjectEl.textContent = subject || "(No Subject)";
        bodyEl.value = ""; // Clear the custom message textarea

        // Show the compose area
        const composeEl = document.getElementById("forwardComposeArea");
        if (typeof show === "function") show("forwardComposeArea");
        else if (composeEl) composeEl.classList.remove("hidden");

        // Scroll to the compose area smoothly if needed
        composeEl?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }

      // 📤 Forward selected Gmail message to students
// 📤 Send the selected email forward
      function sendForwardedEmail() {
        const msgIdEl = document.getElementById("forwardMessageId");
        const bodyEl = document.getElementById("forwardMessage"); // Use the correct ID
        const messageEl = document.getElementById("emailMessage"); // Use the main message area

        if (!msgIdEl || !bodyEl || !messageEl) {
          console.error("Required elements for forwarding missing.");
          alert("Error: UI elements for forwarding are missing.");
          return;
        }

        const messageId = msgIdEl.value.trim();
        const customBody = bodyEl.value.trim(); // Get the introductory text

        const studentEmails = Array.from(
          document.querySelectorAll("#studentList .student-checkbox:checked")
        ).map((e) => e.value);

        if (!messageId) {
          alert("⚠️ Please select an email to forward first using the search results.");
          return;
        }
        if (studentEmails.length === 0) {
          alert("⚠️ Please select at least one student recipient from the list below.");
          return;
        }

        // Confirmation dialog
        if (
          !confirm(
            `📧 Forward this email ${customBody ? "with your introductory message " : ""}to ${studentEmails.length} student${studentEmails.length > 1 ? "s" : ""}?`
          )
        ) {
          return; // Stop if user cancels
        }

        // Display sending status
        messageEl.className = "text-info text-center font-medium status-message";
        messageEl.innerText = "Forwarding emails... Please wait.";
        // Consider disabling the button here to prevent multiple clicks

        google.script.run
          .withSuccessHandler((response) => {
            messageEl.className = `text-sm font-semibold text-center status-message ${
              response.success ? "text-success" : "text-error"
            }`;
            messageEl.innerText = response.message || "Done.";
            // Consider re-enabling the button here

            if (response.success) {
              showToast("Email forwarded successfully!", "success"); // Add toast feedback
              // Clear the forward section after success
              const composeEl = document.getElementById("forwardComposeArea");
              if (typeof hide === "function") hide("forwardComposeArea");
              else if (composeEl) composeEl.classList.add("hidden");

              // Clear the fields
              msgIdEl.value = "";
              const forwardSubjectEl = document.getElementById("forwardSubject");
              if(forwardSubjectEl) forwardSubjectEl.textContent = "(No Subject Selected)";
              bodyEl.value = "";
            } else {
              showToast(response.message || "Failed to forward email.", "error"); // Add error toast
            }

            // Clear status message after a few seconds
            setTimeout(() => {
              messageEl.innerText = "";
              messageEl.className = "status-message";
            }, 5000);
          })
          .withFailureHandler((err) => {
            console.error("forwardAdminEmail failed:", err);
            messageEl.className = "text-error text-center font-semibold status-message";
            messageEl.innerText = `Error: ${err.message || err}`;
            showToast(`Error: ${err.message || "Forwarding failed."}`, "error"); // Add error toast
            // Consider re-enabling the button here

            // Clear status message after a few seconds
            setTimeout(() => {
                messageEl.innerText = "";
                messageEl.className = "status-message";
            }, 5000);
          })
          // Call the backend, passing the customBody
          .forwardAdminEmail(messageId, studentEmails, customBody);
      }

      // 🔄 Reset all email & forward forms
      function resetEmailForm() {
        const elements = {
          formSelect: "emailFormSelect",
          subject: "emailSubject",
          body: "emailBody",
          replyTo: "emailUseReplyTo",
          sender: "emailSenderName",
          searchTerm: "emailSearchTerm",
          searchResults: "emailSearchResults",
          forwardMsg: "forwardMessage",
          composeArea: "forwardComposeArea",
          studentCount: "studentListCount",
          message: "emailMessage",
        };

        if (document.getElementById(elements.formSelect))
          document.getElementById(elements.formSelect).value = "";
        if (document.getElementById(elements.subject))
          document.getElementById(elements.subject).value = "";
        if (document.getElementById(elements.body))
          document.getElementById(elements.body).value = "";
        if (document.getElementById(elements.replyTo))
          document.getElementById(elements.replyTo).checked = false;
        if (document.getElementById(elements.sender))
          document.getElementById(elements.sender).value = "";

        if (document.getElementById(elements.searchTerm))
          document.getElementById(elements.searchTerm).value = "";
        if (document.getElementById(elements.searchResults))
          document.getElementById(elements.searchResults).innerHTML = `
            <div class="flex flex-col items-center justify-center py-8 text-center">
              <i data-lucide="mail-search" class="w-12 h-12 text-neutral mb-3"></i>
              <p class="text-neutral font-medium">No search performed yet</p>
              <p class="text-sm text-neutral/70">Use the search above to find emails to forward</p>
            </div>`;

        if (document.getElementById(elements.forwardMsg))
          document.getElementById(elements.forwardMsg).innerText = "";

        if (typeof hide === "function") hide(elements.composeArea);
        else
          document
            .getElementById(elements.composeArea)
            ?.classList.add("hidden");

        // Reset student selection
        const allCheckboxes = document.querySelectorAll(
          "#studentList .student-checkbox"
        );
        allCheckboxes.forEach((checkbox) => (checkbox.checked = false));
        const selectAll = document.getElementById("selectAllStudents");
        if (selectAll) {
          selectAll.checked = false;
          selectAll.indeterminate = false;
        }

        // Update counter
        if (document.getElementById(elements.studentCount))
          document.getElementById(elements.studentCount).textContent = "0";

        // Clear message
        if (document.getElementById(elements.message)) {
          const el = document.getElementById(elements.message);
          el.innerHTML = "";
          el.className = "status-message";
        }

        refreshLucideIcons?.();
        showToast?.("Email form reset", "info");
      }


      // File upload dropzone functions
      function handleDragOver(event) {
        event.preventDefault();
        event.dataTransfer.dropEffect = 'copy';
        const dropzone = document.getElementById('csvDropzone');
        dropzone.classList.add('border-primary', 'bg-primary/5');
        dropzone.classList.remove('border-base-300');
      }

      function handleDragLeave(event) {
        event.preventDefault();
        const dropzone = document.getElementById('csvDropzone');
        dropzone.classList.remove('border-primary', 'bg-primary/5');
        dropzone.classList.add('border-base-300');
      }

      function handleDrop(event) {
        event.preventDefault();
        const dropzone = document.getElementById('csvDropzone');
        dropzone.classList.remove('border-primary', 'bg-primary/5');
        dropzone.classList.add('border-base-300');
        
        const files = event.dataTransfer.files;
        if (files.length > 0) {
          processFile(files[0]);
        }
      }

      function handleFileSelect(event) {
        const files = event.target.files;
        if (files.length > 0) {
          processFile(files[0]);
        }
      }

      function processFile(file) {
        // Validate file type
        if (!file.name.toLowerCase().endsWith('.csv')) {
          showToast('Please select a CSV file', 'error');
          return;
        }

        // Validate file size (10MB limit)
        if (file.size > 10 * 1024 * 1024) {
          showToast('File size must be less than 10MB', 'error');
          return;
        }

        // Show file preview
        const dropzoneContent = document.getElementById('dropzoneContent');
        const filePreview = document.getElementById('filePreview');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const uploadBtn = document.getElementById('csvUploadBtn');

        dropzoneContent.classList.add('hidden');
        filePreview.classList.remove('hidden');
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        uploadBtn.disabled = false;

        // Read file content
        const reader = new FileReader();
        reader.onload = function(e) {
          const csvData = e.target.result;
          document.getElementById('csvDataInput').value = csvData;
        };
        reader.readAsText(file);

        // Refresh icons
        refreshLucideIcons();
        showToast('File loaded successfully', 'success');
      }

      function clearFile() {
        const dropzoneContent = document.getElementById('dropzoneContent');
        const filePreview = document.getElementById('filePreview');
        const csvDataInput = document.getElementById('csvDataInput');
        const csvFileInput = document.getElementById('csvFileInput');
        const uploadBtn = document.getElementById('csvUploadBtn');

        dropzoneContent.classList.remove('hidden');
        filePreview.classList.add('hidden');
        csvDataInput.value = '';
        csvFileInput.value = '';
        uploadBtn.disabled = true;

        // Refresh icons
        refreshLucideIcons();
        showToast('File cleared', 'info');
      }

      function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
      }

      function processCsvUpload() {
        const e = document.getElementById("csvDataInput").value;
        if (!e) return void showToast("Please select a CSV file first.", "warning");
        const t = document.getElementById("csvUploadBtn"),
          n = t.querySelector(".loading"),
          o = document.getElementById("csvMessage");
        ((t.disabled = !0),
          n.classList.remove("hidden"),
          (o.className = "text-info"),
          (o.innerText = "Processing..."),
          google.script.run
            .withSuccessHandler((e) => {
              ((t.disabled = !1),
                n.classList.add("hidden"),
                (o.className = `text-sm font-semibold ${
                  e.success ? "text-success" : "text-error"
                }`),
                (o.innerText = e.message),
                e.success && clearFile());
            })
            .processStudentCsv(e));
      }
      function searchStudent() {
        const searchTerm = document
          .getElementById("studentSearchInput")
          .value.trim();
        if (!searchTerm) {
          showToast("Please enter a search term", "warning");
          return;
        }

        const resultsContainer = document.getElementById(
          "studentSearchResults",
        );
        const messageEl = document.getElementById("studentMessage");

        // Show loading state
        resultsContainer.innerHTML = `
          <div class="flex flex-col items-center justify-center py-8 text-center">
            <div class="loading loading-dots loading-md text-primary mb-3"></div>
            <p class="text-neutral font-medium">Searching for students...</p>
            <p class="text-sm text-neutral/70">Please wait while we search the database</p>
          </div>
        `;

        setStudentMsg("info", "Searching...");
        hide("studentEditForm");

        google.script.run
          .withSuccessHandler((response) => {
            if (!response.success) {
              resultsContainer.innerHTML = `
                <div class="flex flex-col items-center justify-center py-8 text-center">
                  <i data-lucide="search-x" class="w-12 h-12 text-error mb-3"></i>
                  <p class="text-error font-medium">No students found</p>
                  <p class="text-sm text-neutral/70">${response.message}</p>
                </div>
              `;
              setStudentMsg("error", response.message);
              refreshLucideIcons();
              return;
            }

            setStudentMsg("success", "Student found. Click to edit below.");
            const student = response.data;

            console.log("Search result student object:", student);
            console.log("Student properties:", Object.keys(student));

            // Normalize property names for consistent access
            const rollNo =
              student.RollNo || student.rollNo || student["Roll No"] || "";
            const name = student.Name || student.name || student["Name"] || "";
            const email =
              student.Email ||
              student.email ||
              student["Personal Email ID"] ||
              student["email"] ||
              "";

            // Display search result
            resultsContainer.innerHTML = `
              <div class="student-search-result bg-success/10 rounded-xl p-4 border border-success/20 cursor-pointer hover:bg-success/20 transition-colors" data-rollno="${rollNo}" data-name="${escapeAttr(name)}">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <i data-lucide="user" class="w-8 h-8 text-success"></i>
                    <div>
                      <h5 class="font-semibold text-success">${escapeAttr(name)}</h5>
                      <p class="text-sm text-neutral">Roll No: ${rollNo}</p>
                      <p class="text-xs text-neutral">${email || "No email"}</p>
                    </div>
                  </div>
                  <div class="flex items-center gap-2 text-success">
                    <i data-lucide="edit" class="w-4 h-4"></i>
                    <span class="text-sm font-medium">Click to Edit</span>
                  </div>
                </div>
              </div>
            `;

            // Add event listener for the search result click
            const searchResultElement = resultsContainer.querySelector(
              ".student-search-result",
            );
            if (searchResultElement) {
              searchResultElement.addEventListener("click", function () {
                const rollNoData = this.getAttribute("data-rollno");
                const nameData = this.getAttribute("data-name");
                console.log("Search result clicked:", rollNoData, nameData);
                loadStudentForEdit(rollNoData, nameData);
              });
            }

            refreshLucideIcons();
          })
          .withFailureHandler((error) => {
            resultsContainer.innerHTML = `
              <div class="flex flex-col items-center justify-center py-8 text-center">
                <i data-lucide="alert-circle" class="w-12 h-12 text-error mb-3"></i>
                <p class="text-error font-medium">Search failed</p>
                <p class="text-sm text-neutral/70">Error: ${error.message}</p>
              </div>
            `;
            setStudentMsg("error", "Search failed: " + error.message);
            refreshLucideIcons();
          })
          .getStudentDetails(searchTerm);
      }

      function loadStudentForEdit(rollNo, studentName) {
        console.log("loadStudentForEdit called with:", rollNo, studentName);

        if (!rollNo || rollNo === "undefined") {
          console.error(
            "Invalid rollNo provided to loadStudentForEdit:",
            rollNo,
          );
          setStudentMsg(
            "error",
            "Invalid student data - Roll Number is missing",
          );
          return;
        }

        // Set the student info in the edit form
        document.getElementById("editingStudentRollNo").value = rollNo;
        document.getElementById("editingStudentName").textContent =
          studentName || "Loading...";

        // Load full student data
        google.script.run
          .withSuccessHandler((response) => {
            if (!response.success) {
              setStudentMsg("error", response.message);
              return;
            }

            const student = response.data;
            const fieldsContainer =
              document.getElementById("studentEditFields");
            fieldsContainer.innerHTML = "";

            // Sort fields with RollNo first, then alphabetically
            const sortedFields = Object.keys(student).sort((a, b) => {
              if (a === "RollNo") return -1;
              if (b === "RollNo") return 1;
              if (a === "Password") return -1;
              if (b === "Password") return 1;
              return a.localeCompare(b);
            });

            sortedFields.forEach((fieldName) => {
              const isReadOnly =
                fieldName.toLowerCase() === "rollno" ? "readonly" : "";
              const fieldValue = student[fieldName] || "";

              fieldsContainer.innerHTML += `
                <div class="form-control w-full">
                  <label class="label-text font-medium mb-2 block">
                    <i data-lucide="${fieldName.toLowerCase() === "email" ? "mail" : fieldName.toLowerCase() === "rollno" ? "hash" : fieldName.toLowerCase() === "password" ? "key" : "user"}" class="w-4 h-4 inline mr-2"></i>
                    ${fieldName}
                  </label>
                  <input
                    type="${fieldName.toLowerCase() === "password" ? "password" : "text"}"
                    id="studentEdit_${fieldName}"
                    value="${escapeAttr(fieldValue)}"
                    class="input input-bordered w-full ${isReadOnly ? "input-disabled" : ""}"
                    ${isReadOnly}
                    placeholder="Enter ${fieldName.toLowerCase()}..."
                  />
                  ${isReadOnly ? '<div class="label"><span class="label-text-alt text-neutral">This field cannot be edited</span></div>' : ""}
                </div>
              `;
            });

            show("studentEditForm");
            refreshLucideIcons();
            setStudentMsg("success", "Student loaded for editing.");
          })
          .withFailureHandler((error) => {
            setStudentMsg(
              "error",
              "Failed to load student details: " + error.message,
            );
          })
          .getStudentDetails(rollNo);
      }

      function resetStudentPassword() {
        const rollNo = document.getElementById("editingStudentRollNo").value;
        const studentName =
          document.getElementById("editingStudentName").textContent;

        if (!rollNo) {
          setStudentMsg("error", "No student selected for password reset");
          return;
        }

        if (!confirm(`Reset password for ${studentName} (${rollNo})?`)) return;

        setStudentMsg("info", "Resetting password...");
        google.script.run
          .withSuccessHandler((response) => {
            if (response.success) {
              setStudentMsg(
                "success",
                response.message || "Password reset successfully",
              );
              showToast("Password reset successfully", "success");
              // Refresh the student data to show updated password
              loadStudentForEdit(rollNo, studentName);
            } else {
              setStudentMsg(
                "error",
                response.message || "Failed to reset password",
              );
              showToast("Failed to reset password", "error");
            }
          })
          .withFailureHandler((error) => {
            console.error("Reset password failed:", error);
            setStudentMsg(
              "error",
              "Failed to reset password: " + error.message,
            );
            showToast("Failed to reset password", "error");
          })
          .resetStudentPassword(rollNo);
      }
      function saveStudentChanges() {
        const rollNo = document.getElementById("editingStudentRollNo").value;
        if (!rollNo) {
          setStudentMsg("error", "No student selected for editing");
          return;
        }

        const updatedData = {};
        const editFields = document.querySelectorAll(
          "#studentEditFields input, #studentEditFields textarea, #studentEditFields select",
        );

        editFields.forEach((field) => {
          const fieldName = field.id.replace("studentEdit_", "");
          updatedData[fieldName] = field.value;
        });

        setStudentMsg("info", "Saving changes...");
        google.script.run
          .withSuccessHandler((response) => {
            if (response.success) {
              setStudentMsg("success", "Student details updated successfully");
              showToast("Student details updated successfully", "success");
              // Clear the form after successful save
              const editForm = document.getElementById("studentEditForm");
              if (editForm) {
                editForm.classList.add("hidden");
              }
              // Reset search results
              const resultsContainer = document.getElementById(
                "studentSearchResults",
              );
              resultsContainer.innerHTML = `
                 <div class="flex flex-col items-center justify-center py-8 text-center">
                   <i data-lucide="user-search" class="w-12 h-12 text-neutral mb-3"></i>
                   <p class="text-neutral font-medium">No search performed yet</p>
                   <p class="text-sm text-neutral/70">Use the search above to find student records</p>
                 </div>
               `;
              refreshLucideIcons();
            } else {
              setStudentMsg(
                "error",
                response.message || "Failed to update student details",
              );
              showToast("Failed to update student details", "error");
            }
          })
          .withFailureHandler((error) => {
            console.error("Save student changes failed:", error);
            setStudentMsg("error", "Failed to save changes. Please try again.");
            showToast("Failed to save changes", "error");
          })
          .updateStudentDetails(rollNo, updatedData);
      }

      function hideStudentEditForm() {
        const editForm = document.getElementById("studentEditForm");
        if (editForm) {
          editForm.classList.add("hidden");
        }

        // Clear form data
        document.getElementById("editingStudentRollNo").value = "";
        document.getElementById("editingStudentName").textContent = "";

        // Clear fields container
        const fieldsContainer = document.getElementById("studentEditFields");
        if (fieldsContainer) {
          fieldsContainer.innerHTML = "";
        }

        // Clear any messages
        setStudentMsg("", "");
      }

      function setStudentMsg(type, message) {
        const messageElement = document.getElementById("studentMessage");
        if (messageElement) {
          messageElement.className = `status-message mt-4 text-center font-semibold text-sm text-${type}`;
          messageElement.textContent = message;
          setTimeout(() => {
            messageElement.textContent = "";
            messageElement.className = "status-message mt-4";
          }, 4000);
        }
      }
      function refreshRBACList() {
        const e = "SuperAdmin" === adminRole;
        ((document.getElementById("setRoleBtn").disabled = !e),
          google.script.run
            .withSuccessHandler((t) => {
              const n = document.getElementById("rbacTbody");
              if (((n.innerHTML = ""), !t.success || 0 === t.roles.length))
                return void (n.innerHTML =
                  '<tr><td colspan="3" class="text-center italic text-neutral py-4">No roles configured.</td></tr>');
              t.roles.forEach((o) => {
                const s = document.createElement("tr");
                ((s.className = "hover:bg-base-200 transition-colors"),
                  (s.innerHTML = `<td>${o.email}</td><td><div class="badge badge-neutral">${
                    o.role
                  }</div></td><td>${
                    e
                      ? `<button class="btn btn-xs" onclick="document.getElementById('rbacEmail').value='${o.email}';document.getElementById('rbacRoleSelect').value='${o.role}'">Edit</button>`
                      : "—"
                  }</td>`),
                  n.appendChild(s));
              });
            })
            .withFailureHandler((error) => {
              console.error("getAdminRolesList failed:", error);
              const n = document.getElementById("rbacTbody");
              if (n) {
                n.innerHTML = `<tr><td colspan="3" class="text-center text-error py-4">Error loading roles: ${error.message || error}</td></tr>`;
              }
            })
            .getAdminRolesList());
      }
      function setAdminRoleUI() {
        const e = document.getElementById("rbacEmail").value.trim(),
          t = document.getElementById("rbacRoleSelect").value;
        if (!e) return void alert("Email is required.");
        const n = document.getElementById("rbacResult");
        ((n.className = "text-info"),
          (n.innerText = "Updating..."),
          google.script.run
            .withSuccessHandler((e) => {
              ((n.className = `text-sm font-semibold text-center ${
                e.success ? "text-success" : "text-error"
              }`),
                (n.innerText = e.message),
                e.success &&
                  (refreshRBACList(),
                  (document.getElementById("rbacEmail").value = "")));
            })
            .setAdminRole(e, t));
      }
      // FIX: New functions for Student Profile Config
      function loadStudentProfileConfig() {
        const selectorContainer = document.getElementById(
          "studentProfileSelector",
        );
        const configContainer = document.getElementById(
          "studentProfileConfigList",
        );
        const msgEl = document.getElementById("studentConfigMessage");

        if (!selectorContainer || !configContainer) {
          console.error(
            "Required containers not found for student profile config",
          );
          return;
        }

        // Show loading state in both containers
        selectorContainer.innerHTML = `
          <div class="flex flex-col items-center justify-center py-8 text-center">
            <div class="loading loading-dots loading-md text-primary mb-3"></div>
            <p class="text-neutral font-medium">Loading profile fields...</p>
            <p class="text-sm text-neutral/70">Please wait while we fetch the available options</p>
          </div>
        `;

        configContainer.innerHTML = `
          <div class="flex flex-col items-center justify-center py-8 text-center">
            <div class="loading loading-dots loading-md text-primary mb-3"></div>
            <p class="text-neutral font-medium">Loading configuration...</p>
            <p class="text-sm text-neutral/70">Fetching current field permissions</p>
          </div>
        `;

        google.script.run
          .withSuccessHandler((res) => {
            if (!res.success) {
              const errorMsg = `
                <div class="flex flex-col items-center justify-center py-8 text-center">
                  <i data-lucide="alert-circle" class="w-12 h-12 text-error mb-3"></i>
                  <p class="text-error font-medium">Failed to load configuration</p>
                  <p class="text-sm text-neutral/70">${res.error || res.message}</p>
                </div>
              `;
              selectorContainer.innerHTML = errorMsg;
              configContainer.innerHTML = errorMsg;
              refreshLucideIcons();
              return;
            }

            // Clear containers
            selectorContainer.innerHTML = "";
            configContainer.innerHTML = "";

            if (!res.config || res.config.length === 0) {
              const noDataMsg = `
                <div class="flex flex-col items-center justify-center py-8 text-center">
                  <i data-lucide="inbox" class="w-12 h-12 text-neutral mb-3"></i>
                  <p class="text-neutral font-medium">No profile fields found</p>
                  <p class="text-sm text-neutral/70">No student profile fields are available to configure</p>
                </div>
              `;
              selectorContainer.innerHTML = noDataMsg;
              configContainer.innerHTML = noDataMsg;
              refreshLucideIcons();
              return;
            }

            // Build field checkboxes for selector
            res.config.forEach((field) => {
              const isChecked = field.isEditable ? "checked" : "";
              selectorContainer.innerHTML += `
                <div class="form-control">
                  <label class="label cursor-pointer py-2">
                    <span class="label-text font-medium flex items-center gap-2">
                      <i data-lucide="${getFieldIcon(field.name)}" class="w-4 h-4"></i>
                      ${field.name}
                    </span>
                    <input type="checkbox" value="${field.name}" class="checkbox student-config-checkbox checkbox-primary" ${isChecked} />
                  </label>
                </div>
              `;
            });

            // Build current configuration display
            const editableFields = res.config.filter(
              (field) => field.isEditable,
            );
            const nonEditableFields = res.config.filter(
              (field) => !field.isEditable,
            );

            if (editableFields.length > 0) {
              configContainer.innerHTML += `
                <div class="mb-4">
                  <h5 class="font-medium text-success mb-2 flex items-center gap-2">
                    <i data-lucide="check-circle" class="w-4 h-4"></i>
                    Editable Fields (${editableFields.length})
                  </h5>
                  <div class="space-y-1">
                    ${editableFields
                      .map(
                        (field) => `
                      <div class="badge badge-success gap-2">
                        <i data-lucide="${getFieldIcon(field.name)}" class="w-3 h-3"></i>
                        ${field.name}
                      </div>
                    `,
                      )
                      .join("")}
                  </div>
                </div>
              `;
            }

            if (nonEditableFields.length > 0) {
              configContainer.innerHTML += `
                <div>
                  <h5 class="font-medium text-neutral mb-2 flex items-center gap-2">
                    <i data-lucide="x-circle" class="w-4 h-4"></i>
                    Read-Only Fields (${nonEditableFields.length})
                  </h5>
                  <div class="space-y-1">
                    ${nonEditableFields
                      .map(
                        (field) => `
                      <div class="badge badge-neutral gap-2">
                        <i data-lucide="${getFieldIcon(field.name)}" class="w-3 h-3"></i>
                        ${field.name}
                      </div>
                    `,
                      )
                      .join("")}
                  </div>
                </div>
              `;
            }

            refreshLucideIcons();
            if (msgEl) {
              msgEl.className =
                "status-message text-center text-success font-medium";
              msgEl.textContent = "Profile configuration loaded successfully";
              setTimeout(() => {
                msgEl.textContent = "";
                msgEl.className = "status-message";
              }, 3000);
            }
          })
          .withFailureHandler((err) => {
            console.error("Load student profile config failed:", err);
            const errorMsg = `
              <div class="flex flex-col items-center justify-center py-8 text-center">
                <i data-lucide="alert-circle" class="w-12 h-12 text-error mb-3"></i>
                <p class="text-error font-medium">Error loading configuration</p>
                <p class="text-sm text-neutral/70">${err.message || "Please try again"}</p>
              </div>
            `;
            selectorContainer.innerHTML = errorMsg;
            configContainer.innerHTML = errorMsg;
            refreshLucideIcons();

            if (msgEl) {
              msgEl.className =
                "status-message text-center text-error font-medium";
              msgEl.textContent = `Error: ${err.message || "Failed to load configuration"}`;
              setTimeout(() => {
                msgEl.textContent = "";
                msgEl.className = "status-message";
              }, 4000);
            }
          })
          .getStudentProfileConfig();
      }

      function getFieldIcon(fieldName) {
        const field = fieldName.toLowerCase();
        if (field.includes("email")) return "mail";
        if (field.includes("roll") || field.includes("id")) return "hash";
        if (field.includes("password")) return "key";
        if (field.includes("phone") || field.includes("mobile")) return "phone";
        if (field.includes("address")) return "map-pin";
        if (
          field.includes("cgpa") ||
          field.includes("gpa") ||
          field.includes("grade")
        )
          return "award";
        if (field.includes("name")) return "user";
        return "file-text";
      }
      function saveStudentProfileConfig() {
        const msgEl = document.getElementById("studentConfigMessage");
        if (!msgEl) {
          console.error("studentConfigMessage element not found");
          return;
        }

        const config = [];
        document.querySelectorAll(".student-config-checkbox").forEach((cb) => {
          config.push({
            name: cb.value,
            isEditable: cb.checked,
          });
        });

        // Show loading state
        msgEl.className = "status-message text-info text-center font-medium";
        msgEl.textContent = "Saving configuration...";

        google.script.run
          .withSuccessHandler((res) => {
            msgEl.className = `status-message text-center font-semibold ${res.success ? "text-success" : "text-error"}`;
            msgEl.textContent =
              res.message ||
              (res.success
                ? "Configuration saved successfully"
                : "Failed to save configuration");

            if (res.success) {
              showToast("Profile configuration saved successfully", "success");
              // Reload the configuration to show updated state
              setTimeout(() => {
                loadStudentProfileConfig();
                msgEl.textContent = "";
                msgEl.className = "status-message";
              }, 2000);
            } else {
              showToast("Failed to save profile configuration", "error");
              setTimeout(() => {
                msgEl.textContent = "";
                msgEl.className = "status-message";
              }, 4000);
            }
          })
          .withFailureHandler((err) => {
            console.error("Save student profile config failed:", err);
            msgEl.className =
              "status-message text-center font-semibold text-error";
            msgEl.textContent = `Error: ${err.message || "Failed to save configuration"}`;
            showToast("Failed to save profile configuration", "error");
            setTimeout(() => {
              msgEl.textContent = "";
              msgEl.className = "status-message";
            }, 4000);
          })
          .setStudentProfileConfig(config);
      }
      document.addEventListener("DOMContentLoaded", initAdminPanel);
      console.log("Admin Panel Script Loaded");
    </script>

    <script>
      // Initialize Lucide icons
      document.addEventListener("DOMContentLoaded", function () {
        if (typeof lucide !== "undefined") {
          lucide.createIcons();
        }
      });

      // Re-initialize icons after dynamic content changes
      function refreshLucideIcons() {
        if (typeof lucide !== "undefined") {
          lucide.createIcons();
        }
      }

      // Override the original refreshForms to include icon refresh
      const originalRefreshForms = refreshForms;
      refreshForms = function () {
        originalRefreshForms.call(this);
        // Add a small delay to ensure DOM is updated before refreshing icons
        setTimeout(refreshLucideIcons, 100);
      };
    </script>
  </body>
</html>
